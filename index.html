<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ministry of Health - Vehicle Booking System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ========== CSS VARIABLES ========== */
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d47a1;
            --secondary: #34a853;
            --danger: #ea4335;
            --warning: #f9ab00;
            --light: #f8f9fa;
            --dark: #202124;
            --gray: #5f6368;
            --border: #dadce0;
            --success: #28a745;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        /* ========== RESET & BASE STYLES ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            padding: 0 20px;
            margin: 0 auto;
        }
        
        /* ========== LOGIN SCREEN ========== */
        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
        }
        
        .login-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .login-card:hover {
            transform: translateY(-5px);
        }
        
        .login-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto 25px;
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
            box-shadow: 0 4px 15px rgba(26, 115, 232, 0.3);
        }
        
        .login-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--dark);
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .login-subtitle {
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        /* ========== FORM STYLES ========== */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background-color: #f8f9fa;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
            background-color: white;
        }
        
        .role-selector {
            display: flex;
            margin-bottom: 25px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid var(--border);
            background: #f8f9fa;
        }
        
        .role-option {
            flex: 1;
            padding: 14px;
            text-align: center;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .role-option.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            padding: 10px 0;
        }
        
        .checkbox-group input {
            margin-right: 12px;
            transform: scale(1.2);
        }
        
        .form-text {
            color: var(--gray);
            font-size: 14px;
            margin-top: 5px;
            display: block;
        }
        
        /* ========== BUTTON STYLES ========== */
        .btn {
            display: inline-block;
            padding: 14px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 115, 232, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, #2d8c47 100%);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(52, 168, 83, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #d33426 100%);
        }
        
        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(234, 67, 53, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-block {
            width: 100%;
        }
        
        .whatsapp-btn {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .whatsapp-btn:hover {
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-right: 8px;
            transition: all 0.3s;
        }
        
        /* ========== DASHBOARD STYLES ========== */
        .dashboard {
            display: none;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            box-shadow: var(--shadow);
            padding: 18px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-weight: 700;
            font-size: 20px;
            color: white;
        }
        
        .logo-icon {
            margin-right: 12px;
            font-size: 28px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-name {
            color: white;
            font-weight: 600;
        }
        
        .main-content {
            padding: 30px 0;
        }
        
        .page-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 30px;
            color: var(--dark);
            text-align: center;
        }
        
        /* ========== BOOKING FORM STYLES ========== */
        .booking-form {
            background-color: white;
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 35px;
            margin-bottom: 40px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .form-section {
            margin-bottom: 35px;
        }
        
        .section-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -12px;
        }
        
        .form-col {
            flex: 1 0 100%;
            padding: 0 12px;
            margin-bottom: 20px;
        }
        
        /* ========== TAB STYLES ========== */
        .admin-tabs, .user-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 3px solid var(--border);
            background: white;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .admin-tab, .user-tab {
            padding: 18px 30px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            color: var(--gray);
            position: relative;
        }
        
        .admin-tab.active, .user-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: rgba(26, 115, 232, 0.05);
        }
        
        .admin-tab-content, .user-tab-content {
            display: block;
        }
        
        /* ========== NOTIFICATION BADGE ========== */
        .notification-badge {
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 8px;
            right: 8px;
        }
        
        /* ========== TABLE STYLES ========== */
        .requests-table, .data-table-container {
            background-color: white;
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .table-header, .data-table-header {
            padding: 25px;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .table-title, .data-table-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .table-container, .table-scroll-container {
            overflow-x: auto;
            max-height: 600px;
            position: relative;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 18px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 700;
            color: var(--gray);
            font-size: 15px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .highlighted-row {
            background-color: rgba(26, 115, 232, 0.08) !important;
            border-left: 4px solid var(--primary);
        }
        
        /* ========== STATUS BADGES ========== */
        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .status-pending {
            background-color: #fff8e1;
            color: var(--warning);
            border: 1px solid #ffecb3;
        }
        
        .status-approved {
            background-color: #e8f5e9;
            color: var(--secondary);
            border: 1px solid #c8e6c9;
        }
        
        .status-rejected {
            background-color: #ffebee;
            color: var(--danger);
            border: 1px solid #ffcdd2;
        }
        
        .status-completed {
            background-color: #e3f2fd;
            color: var(--primary);
            border: 1px solid #bbdefb;
        }
        
        .vehicle-type-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .vehicle-type-car {
            background-color: #e8f0fe;
            color: var(--primary);
            border: 1px solid #d2e3fc;
        }
        
        .vehicle-type-van {
            background-color: #e6f4ea;
            color: var(--secondary);
            border: 1px solid #ceead6;
        }
        
        .vehicle-type-bus {
            background-color: #fce8e6;
            color: var(--danger);
            border: 1px solid #f9c9c4;
        }
        
        /* ========== MODAL STYLES ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: white;
            border-radius: 16px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalAppear 0.3s ease-out;
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .modal-header {
            padding: 25px;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s;
        }
        
        .close-modal:hover {
            color: var(--danger);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 25px;
            border-top: 2px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            background: #f8f9fa;
        }
        
        /* ========== VEHICLE STATUS CARDS ========== */
        .vehicle-status-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .status-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 25px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
        }
        
        .status-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .status-card-title {
            font-size: 18px;
            font-weight: 700;
        }
        
        .status-card-count {
            font-size: 32px;
            font-weight: 800;
        }
        
        .status-card-available {
            color: var(--secondary);
        }
        
        .status-card-booked {
            color: var(--warning);
        }
        
        .status-card-maintenance {
            color: var(--danger);
        }
        
        .vehicle-list {
            list-style: none;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .vehicle-list li {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .vehicle-list li:last-child {
            border-bottom: none;
        }
        
        /* ========== STATS CARDS ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            font-size: 40px;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .stat-label {
            font-size: 16px;
            color: var(--gray);
            font-weight: 600;
        }
        
        /* ========== ENHANCED PDF STYLES ========== */
        .enhanced-pdf {
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 35px;
            margin-top: 25px;
            background-color: white;
            box-shadow: var(--shadow);
        }
        
        .enhanced-pdf-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 3px solid var(--primary);
        }
        
        .enhanced-pdf-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .enhanced-pdf-subtitle {
            font-size: 18px;
            color: var(--gray);
            font-weight: 500;
        }
        
        .enhanced-pdf-section {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid var(--primary);
        }
        
        .enhanced-pdf-label {
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark);
            font-size: 15px;
        }
        
        .enhanced-pdf-value {
            margin-bottom: 12px;
            color: var(--gray);
            font-size: 16px;
        }
        
        .enhanced-pdf-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        /* ========== SUCCESS MESSAGE ========== */
        .success-message {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid var(--secondary);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            margin: 25px 0;
            box-shadow: var(--shadow);
        }
        
        .success-message h2 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 24px;
        }
        
        .success-message p {
            color: var(--dark);
            font-size: 16px;
        }
        
        .password-notice {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .password-value {
            font-family: 'Courier New', monospace;
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px dashed var(--primary);
            display: inline-block;
            margin: 10px 0;
        }
        
        /* ========== ADMIN CONTROLS ========== */
        .admin-controls, .report-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .filter-control, .report-control {
            flex: 1;
            min-width: 250px;
        }
        
        .search-control {
            position: relative;
        }
        
        .search-control .form-control, .search-container .form-control {
            padding-left: 40px;
        }
        
        .search-control i, .search-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        /* ========== SELECTION LISTS ========== */
        .selection-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .selection-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .selection-item:hover {
            background-color: #f5f7fa;
        }
        
        .selection-item.selected {
            background-color: #e3f2fd;
            border-left: 4px solid var(--primary);
        }
        
        .selection-item:last-child {
            border-bottom: none;
        }
        
        /* ========== PAGINATION ========== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 25px;
            gap: 15px;
            padding: 20px;
        }
        
        .pagination button {
            padding: 10px 20px;
            border: 2px solid var(--border);
            background-color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .pagination button:hover:not(:disabled) {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-info {
            margin: 0 20px;
            font-size: 15px;
            color: var(--gray);
            font-weight: 500;
        }
        
        /* ========== QR CODE ========== */
        .qrcode-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        
        .qrcode {
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        /* ========== SIGNATURE SECTION ========== */
        .signature-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid var(--border);
        }
        
        .signature-line {
            height: 1px;
            background: var(--dark);
            margin: 30px 0 10px;
        }
        
        .signature-label {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .signature-name {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .signature-title {
            font-size: 14px;
            color: var(--gray);
        }
        
        /* ========== UTILITY CLASSES ========== */
        .text-center {
            text-align: center;
        }
        
        .mt-20 {
            margin-top: 20px;
        }
        
        .mb-20 {
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        /* ========== LOADING SPINNER ========== */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* ========== SCROLLBAR STYLING ========== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* ========== FIXED USER BUTTON STYLES ========== */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 2px solid var(--border);
        }

        .button-group .btn {
            flex: 1;
            min-width: 200px;
            max-width: 300px;
            margin: 0;
        }

        .button-group .whatsapp-btn {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex: 1;
            min-width: 200px;
            max-width: 300px;
        }

        .button-group .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, #2d8c47 100%);
            flex: 1;
            min-width: 200px;
            max-width: 300px;
        }
        
        /* ========== RESPONSIVE DESIGN ========== */
        @media (min-width: 576px) {
            .form-col {
                flex: 1 0 50%;
            }
        }
        
        @media (min-width: 992px) {
            .form-col {
                flex: 1 0 33.333%;
            }
        }
        
        @media (max-width: 1200px) {
            .container {
                max-width: 100%;
                padding: 0 15px;
            }
            
            .vehicle-status-cards {
                grid-template-columns: 1fr 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .login-card {
                padding: 25px;
            }
            
            .booking-form {
                padding: 20px;
            }
            
            .table-header, .data-table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .admin-controls, .report-controls {
                flex-direction: column;
            }
            
            .filter-control, .report-control {
                width: 100%;
            }
            
            .admin-tabs, .user-tabs {
                flex-wrap: wrap;
            }
            
            .admin-tab, .user-tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
                padding: 15px 20px;
            }
            
            .vehicle-status-cards {
                grid-template-columns: 1fr;
            }
            
            .enhanced-pdf-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .data-table-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .data-table-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .form-col {
                flex: 1 0 100%;
            }
            
            .button-group {
                flex-direction: column;
                align-items: center;
                gap: 12px;
                padding: 15px;
            }
            
            .button-group .btn,
            .button-group .whatsapp-btn,
            .button-group .btn-secondary {
                min-width: 100%;
                max-width: 100%;
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .pagination {
                flex-wrap: wrap;
            }
            
            .admin-tab, .user-tab {
                flex: 1 0 100%;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .modal-footer {
                padding: 15px;
                flex-direction: column;
            }
            
            .modal-footer .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .button-group {
                gap: 10px;
                padding: 12px;
            }
            
            .button-group .btn {
                padding: 12px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-logo">ðŸš‘</div>
            <h1 class="login-title">Vehicle Booking System</h1>
            <p class="login-subtitle">Ministry of Health</p>
            
            <div class="role-selector">
                <div class="role-option active" data-role="user">User</div>
                <div class="role-option" data-role="admin">Admin</div>
            </div>
            
            <div class="form-group">
    <label class="form-label" for="userSelect">Select User</label>
    <select id="userSelect" class="form-control">
        <option value="">Select User</option>

        <option value="dhi">Director (Health Information)</option>
        <option value="da1">Director Administration I</option>
        <option value="dna2">Director Nursing Admin II</option>
        <option value="da2t">Director Admin II (Technical)</option>
        <option value="da3nta">Director Admin III (NTA)</option>
        <option value="da4">Director Admin IV</option>
        <option value="da5">Director Admin V</option>
        <option value="da6">Director Admin VI</option>
        <option value="da7">Director Admin VII</option>
        <option value="daex">Director Admin (Exam)</option>
        <option value="dt">Director (Transport)</option>
        <option value="dds">Director Dental Services</option>
        <option value="dtr">Director Training</option>
        <option value="dre">Director Research</option>
        <option value="dne">Director Nursing (Education)</option>
        <option value="cas">Chief Accountant (Stock)</option>
        <option value="cab">Chief Accountant (Book)</option>
        <option value="cac">Chief Accountant (Care)</option>
        <option value="ae1">Accountant (Expenditure) I</option>
        <option value="ae2">Accountant (Expenditure) II</option>
        <option value="ae3">Accountant (Expenditure) III</option>
        <option value="as">Accountant (Supplies)</option>
        <option value="di1">Director Investigation I</option>
        <option value="di2">Director Investigation II</option>
        <option value="dls">Director Laboratory Services</option>
        <option value="dba">Director Buildings (Admin)</option>
        <option value="dbe">Director Buildings (Engineering)</option>
        <option value="dp">Director Planning</option>
        <option value="dod">Director Organization & Dev</option>
        <option value="dih">Director International Health</option>
        <option value="dpa">Director Policy Analysis</option>
        <option value="dsu">Director Statistics Unit</option>
        <option value="afp">Accountant Finance (Planning)</option>
        <option value="dam1">Director Admin Medical I</option>
        <option value="dam2">Director Admin Medical II</option>
        <option value="dms">Director Medical Services</option>
        <option value="dtc">Director Tertiary Care</option>
        <option value="dpc">Director Primary Care</option>
        <option value="dph">Director Private Health</option>
        <option value="dnm">Director Nursing (Medical)</option>
        <option value="dqs">Director Quality & Safety</option>
        <option value="dncd">Director NCD</option>
        <option value="dmh">Director Mental Health</option>
        <option value="dfs">Director Food Safety</option>
        <option value="deu">Director Estate & Urban Health</option>
        <option value="dq">Director Quarantine</option>
        <option value="dve">Director Youth/Elderly/Disabled</option>
        <option value="dnp">Director Nursing (Public Health)</option>

        <option value="ddgp">DDG Planning</option>
        <option value="ddga1">DDG Admin I</option>
        <option value="ddga2">DDG Admin II</option>
        <option value="ddga3">DDG Admin III</option>
        <option value="ddgd">DDG Dental Services</option>
        <option value="ddger">DDG Education/Research</option>
        <option value="ddgi">DDG Investigation</option>
        <option value="ddgl">DDG Lab Services</option>
        <option value="ddglog">DDG Logistics</option>
        <option value="ddgm1">DDG Medical Services I</option>
        <option value="ddgm2">DDG Medical Services II</option>
        <option value="ddgph1">DDG Public Health I</option>
        <option value="ddgph2">DDG Public Health II</option>
        <option value="ddgncd">DDG NCD</option>
        <option value="ddgeh">DDG Env & Health Safety</option>

        <option value="sasadm">Senior Asst Sec Admin</option>
        <option value="sasfs">Senior Asst Sec Flying Squad</option>
        <option value="sasp">Senior Asst Sec Info</option>
        <option value="sasmed">Senior Asst Sec Medical</option>
        <option value="sasp1">Senior Asst Sec Procurement I</option>
        <option value="sasp2">Senior Asst Sec Procurement II</option>
        <option value="sasdev">Senior Asst Sec Development</option>

        <option value="dgh">Director General Health</option>

        <option value="asa1">Add Sec Admin I</option>
        <option value="asa2">Add Sec Admin II</option>
        <option value="asdev">Add Sec Development</option>
        <option value="asmed">Add Sec Medical</option>
        <option value="asph">Add Sec Public Health</option>
        <option value="asproc">Add Sec Procurement</option>
        <option value="aseng">Add Sec Engineering</option>

        <option value="cfo1">Chief Finance Officer I</option>
        <option value="cfo2">Chief Finance Officer II</option>
        <option value="cfo3">Chief Finance Officer III</option>

        <option value="soh">Secretary of Health</option>
    </select>
</div>
            
            <div class="form-group">
                <label class="form-label" for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter your password">
                <small class="form-text">For System Inquiries 011 2 692 382</small>
            </div>
            
            <button id="loginBtn" class="btn btn-block">Login to System</button>
            <div id="loginSpinner" class="spinner mt-20" style="display: none;"></div>
            <div id="loginMessage" class="mt-20" style="color: var(--danger); display: none;"></div>
        </div>
    </div>
    
    <!-- User Dashboard -->
    <div id="userDashboard" class="dashboard">
        <div class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <span class="logo-icon">ðŸš‘</span>
                        <span>VBS - Ministry of Health</span>
                    </div>
                    <div class="user-info">
                        <span class="user-name" id="userDisplayName">Staff Member</span>
                        <button id="userLogout" class="logout-btn">Logout</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="container">
                <h1 class="page-title">Vehicle Booking System</h1>
                
                <div class="user-tabs">
                    <div class="user-tab active" data-tab="booking">Booking Request</div>
                    <div class="user-tab" data-tab="myRequests">My Requests</div>
                    <div class="user-tab" data-tab="vehicles">Vehicle Status</div>
                </div>
                
                <!-- Booking Request Tab -->
                <div id="bookingTab" class="user-tab-content">
                    <div class="booking-form" id="bookingForm">
                        <div class="form-section">
                            <h2 class="section-title">User Information</h2>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="userName">Full Name *</label>
                                        <input type="text" id="userName" class="form-control" placeholder="Enter your full name" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="userDesignation">Designation/Post *</label>
                                        <input type="text" id="userDesignation" class="form-control" placeholder="Enter your designation" required>
                                    </div>
                                </div>
                                <div class="form-col">
    <div class="form-group">
        <label class="form-label" for="userBranch">Branch/Section *</label>
        <input type="text" id="userBranch" class="form-control" placeholder="Enter your branch/section" required>
    </div>
</div>

                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="userPhone">Phone Number *</label>
                                        <input type="tel" id="userPhone" class="form-control" placeholder="Enter your phone number" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="approvedBy">Approved By *</label>
                                        <input type="text" id="approvedBy" class="form-control" placeholder="Select approving authority" list="approvedByList" required>
                                        <datalist id="approvedByList">
					    <option value="Director (Health Information)">
                                            <option value="Director-Administration - I">
					    <option value="Director â€“ (Nursing Administration â€“ II)">
					    <option value="Director Administration II (Technical Adminstration)">
                                            <option value="Director Administration - III (Non Technical Administration) (NTA)">
					    <option value="Director Administration IV">
<option value="Director-Administration - V">
<option value="Director-Administration â€“ VI">
<option value="Director-Administration â€“ VII">
<option value="Director Administration (Exam)">
<option value="Director (Transport)">
<option value="Director-Dental Services">
<option value="Director-Training">
<option value="Director-Research">
<option value="Director - Nursing (Education)">
<option value="Chief Accountant (Stock Verification )">
<option value="Chief Accountant (Book Keeping)">
<option value="Chief Accountant - Care & Co-ordination">
<option value="Accountant (Expenditure) I">
<option value="Accountant (Expenditure) II">
<option value="Accountant (Expenditure) III">
<option value="Accountant (Supplies)">
<option value="Director-Investigation I">
<option value="Director-Investigation II">
<option value="Director - Laboratory Services">
<option value="Director-Buildings (Administration)">
<option value="Director- Buildings (Engineering)">
<option value="Director-Planning">
<option value="Director-Organization & Development">
<option value="Director - International Health">
<option value="Director - Policy Analysis and Development">
<option value="Director - Statics Unit">
<option value="Accountant - Finance (Planning )">
<option value="Director-Administration (Medical Services- I)">
<option value="Director â€“ Administration (Medical Service-II)">
<option value="Director-Medical Services">
<option value="Director - Tertiary Care Services">
<option value="Director-Primary Care Services">
<option value="Director - Private Health Sector Development">
<option value="Director - Nursing (Medical Services)">
<option value="Director - Health Care, Quality & Safety">
<option value="Director â€“Non Communicable Diseases">
<option value="Director - Mental Health">
<option value="Director- Environment Health Occupational Health& Food Safety">
<option value="Director-Estate & Urban Health">
<option value="Director-Quarantine">
<option value="Director-Youth, Elderly, Disabled & Displaced ">
<option value="Director-Nursing (Public Health Services)">
<option value="Director - Health Care, Quality & Safety">



                                            <option value="Deputy Director General (Planning)">
                                            <option value="Deputy Director General (Administration) I">
                                            <option value="Deputy Director General (Administration) II">
                                            <option value="Deputy Director General (Administration) III">
                                            <option value="Deputy Director General (Dental Services)">
                                            <option value="Deputy Director General (Education, Training & Research)">
<option value="Deputy Director General (Investigation)">
<option value="Deputy Director General (Laboratory Services)">
<option value="Deputy Director General (Logistics)">
<option value="Deputy Director General(Medical Services- I )">
<option value="Deputy Director General(Medical Services-II)">
<option value="Deputy Director General (Public Health Services-I)">
<option value="Deputy Director General (Public Health Services-II)">
<option value="Deputy Director General (Non Communicable Diseases)">
<option value="Deputy Director General Environment Health, Occupational Health & Food safety">
<option value="Senior Assistant Secretary (Administration)">
<option value="Senior Assistant Secretary (Flying Squad)">
<option value="Senior Assistant Secretary (Information and Promotion)">
<option value="Senior Assistant Secretary (Medical Services)">
<option value="Senior Assistant Secretary (Procurement) I">
<option value="Senior Assistant Secretary (Procurement) II">
<option value="Senior Assistant Secretary (Development)">
<option value="Director General Of Health Service">
                                           
<option value="Additional Secretary (Administration) I">
<option value="Additional Secretary (Administration) II">
<option value="Additional Secretary (Development)">
<option value="Additional Secretary (Medical Services)">
<option value="Additional Secretary (Public Health Services)">
<option value="Additional Secretary (Procurement)">
<option value="Additional Secretary (Engineering)">
<option value="Chief Finance Officer I">
<option value="Chief Finance Officer II">
<option value="Chief Finance Officer III">
 <option value="Secretary of Health">
                                        </datalist>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h2 class="section-title">Trip Details</h2>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="purpose">Purpose of Travel/Vehicle Requirement *</label>
                                        <textarea id="purpose" class="form-control" rows="3" placeholder="Describe the purpose of your travel" required></textarea>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="seatCount">Required Vehicle Seat Count *</label>
                                        <select id="seatCount" class="form-control" required>
                                            <option value="">Select seat count</option>
                                            <option value="4">4 Seater</option>
                                            <option value="7">7 Seater</option>
                                            <option value="15">15+ Seater</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="distance">Approximate Distance (KM) *</label>
                                        <input type="number" id="distance" class="form-control" placeholder="Enter approximate distance in KM" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="goodsTransport">
                                        <label class="form-label" for="goodsTransport">Requirement for Goods Transport</label>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="startDateTime">Start Date and Time *</label>
                                        <input type="datetime-local" id="startDateTime" class="form-control" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="endDateTime">End Date and Time *</label>
                                        <input type="datetime-local" id="endDateTime" class="form-control" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="startLocation">Starting Location *</label>
                                        <input type="text" id="startLocation" class="form-control" placeholder="Enter starting location" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="destination">Destination *</label>
                                        <input type="text" id="destination" class="form-control" placeholder="Enter destination" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button id="submitBooking" class="btn btn-block">Submit Booking Request</button>
                        <div id="submitSpinner" class="spinner mt-20" style="display: none;"></div>
                    </div>
                    
                    <div id="bookingSuccess" class="hidden">
                        <div class="success-message">
                            <h2>Booking Submitted Successfully!</h2>
                            <p>Your vehicle booking request has been submitted and is pending approval.</p>
                            <div class="password-notice">
                                <h3>Your Booking Password: <span id="uniquePasswordDisplay" class="password-value"></span></h3>
                                <p><strong>Important:</strong> Save this password. You'll need it for any updates or inquiries about this booking.</p>
                            </div>
                        </div>
                        
                        <div class="enhanced-pdf" id="enhancedPdfPreview">
                            <div class="enhanced-pdf-header">
                                <div class="enhanced-pdf-title">Ministry of Health</div>
                                <div class="enhanced-pdf-subtitle">Vehicle Booking Confirmation</div>
                            </div>
                            <div class="enhanced-pdf-grid">
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Booking Reference:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfRefNumber">VBS-2023-001</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Unique Password:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfPassword">XXXXXX</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Submission Date:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfDate">01/01/2023</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Requestor Details:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfUserDetails">Name, Designation, Phone</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Branch/Section:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfBranch">Branch Name</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Approved By:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfApprovedBy">Approving Authority</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Trip Details:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfTripDetails">Purpose, Dates, Locations</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Vehicle Requirements:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfVehicleReq">Seats, Goods Transport</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Approximate Distance:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfDistance">0 KM</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Status:</div>
                                    <div class="enhanced-pdf-value">Pending Approval</div>
                                </div>
                            </div>
                            <div class="qrcode-container">
                                <div id="qrCodeUser" class="qrcode"></div>
                            </div>
                            <div class="signature-section">
                                <div class="signature-line"></div>
                                <div class="signature-label">Approval Signature:</div>
                                <div class="signature-name">_________________________</div>
                                <div class="signature-title">Head of Department / Deputy Director General</div>
                            </div>
                        </div>
                        <div class="button-group">
                            <button id="downloadPdf" class="btn">Download Confirmation</button>
                            <button id="sendWhatsApp" class="btn whatsapp-btn">
                                <i class="fab fa-whatsapp"></i> Send via WhatsApp
                            </button>
                            <button id="newBooking" class="btn btn-secondary">Make Another Booking</button>
                        </div>
                    </div>
                </div>
                
                <!-- My Requests Tab -->
                <div id="myRequestsTab" class="user-tab-content hidden">
                    <div class="admin-controls">
                        <div class="filter-control">
                            <label class="form-label" for="myRequestsStatusFilter">Filter by Status</label>
                            <select id="myRequestsStatusFilter" class="form-control">
                                <option value="all">All Requests</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="search-control filter-control">
                            <label class="form-label" for="searchMyRequests">Search My Requests</label>
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchMyRequests" class="form-control" placeholder="Search by reference or destination">
                            </div>
                        </div>
                    </div>
                    
                    <div class="requests-table">
                        <div class="table-header">
                            <div class="table-title">My Booking Requests</div>
                            <div id="myRequestCount">0 requests</div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref No.</th>
                                        <th>Destination</th>
                                        <th>Date/Time</th>
                                        <th>Seats</th>
                                        <th>Distance</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="myRequestsTableBody"></tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button id="myRequestsPrevPage" disabled>Previous</button>
                            <span class="pagination-info" id="myRequestsPageInfo">Page 1 of 1</span>
                            <button id="myRequestsNextPage" disabled>Next</button>
                        </div>
                        
                        <div id="myRequestsSpinner" class="spinner mt-20 mb-20" style="display: none;"></div>
                    </div>
                </div>
                
                <!-- Vehicle Status Tab -->
                <div id="vehiclesTab" class="user-tab-content hidden">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-car"></i></div>
                            <div class="stat-value" id="userTotalVehicles">0</div>
                            <div class="stat-label">Total Vehicles</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="stat-value" id="userAvailableCount">0</div>
                            <div class="stat-label">Available</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
                            <div class="stat-value" id="userBookedCount">0</div>
                            <div class="stat-label">Booked</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-tools"></i></div>
                            <div class="stat-value" id="userMaintenanceCount">0</div>
                            <div class="stat-label">Maintenance</div>
                        </div>
                    </div>
                    
                    <div class="user-vehicle-status">
                        <h2 class="section-title">Vehicle Status Overview</h2>
                        <p>Current status of all vehicles in the Ministry of Health fleet.</p>
                        
                        <div class="data-table-controls mb-20">
                            <div class="search-control">
                                <div class="search-container">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchUserVehicles" class="form-control" placeholder="Search vehicles...">
                                </div>
                            </div>
                            <div class="pagination-info" id="userVehiclePageInfo">Page 1 of 1</div>
                        </div>
                        
                        <div class="table-scroll-container">
                            <table class="user-vehicle-table">
                                <thead>
                                    <tr>
                                        <th>Vehicle No</th>
                                        <th>Type</th>
                                        <th>Seat Capacity</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="userVehiclesList">
                                    <!-- Vehicles will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button id="userPrevPage" disabled>Previous</button>
                            <span class="pagination-info" id="userVehiclePaginationInfo">Page 1 of 1</span>
                            <button id="userNextPage" disabled>Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="dashboard">
        <div class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <span class="logo-icon">ðŸš‘</span>
                        <span>VBS Admin - Ministry of Health</span>
                    </div>
                    <div class="user-info">
                        <span class="user-name" id="adminDisplayName">Administrator</span>
                        <button id="adminLogout" class="logout-btn">Logout</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="container">
                <h1 class="page-title">Booking Requests Management</h1>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-list-alt"></i></div>
                        <div class="stat-value" id="totalBookings">0</div>
                        <div class="stat-label">Total Bookings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="stat-value" id="pendingBookings">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-value" id="approvedBookings">0</div>
                        <div class="stat-label">Approved</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-car"></i></div>
                        <div class="stat-value" id="totalVehicles">0</div>
                        <div class="stat-label">Total Vehicles</div>
                    </div>
                </div>
                
                <div class="admin-tabs">
                    <div class="admin-tab active" data-tab="requests">
                        Booking Requests
                        <span id="pendingBookingBadge" class="notification-badge" style="display: none;">0</span>
                    </div>
                    <div class="admin-tab" data-tab="vehicles">Vehicle Status</div>
                    <div class="admin-tab" data-tab="reports">Reports</div>
                    <div class="admin-tab" data-tab="logs">System Logs</div>
                </div>
                
                <!-- Booking Requests Tab -->
                <div id="requestsTab" class="admin-tab-content">
                    <div class="admin-controls">
                        <div class="filter-control">
                            <label class="form-label" for="statusFilter">Filter by Status</label>
                            <select id="statusFilter" class="form-control">
                                <option value="all">All Requests</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="search-control filter-control">
                            <label class="form-label" for="searchBookings">Search Bookings</label>
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchBookings" class="form-control" placeholder="Search by reference, name, or destination">
                            </div>
                        </div>
                    </div>
                    
                    <div class="requests-table">
                        <div class="table-header">
                            <div class="table-title">Booking Requests</div>
                            <div id="requestCount">0 requests</div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref No.</th>
                                        <th>Requester</th>
                                        <th>Branch</th>
                                        <th>Destination</th>
                                        <th>Date/Time</th>
                                        <th>Seats</th>
                                        <th>Distance</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="requestsTableBody"></tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button id="prevPage" disabled>Previous</button>
                            <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
                            <button id="nextPage" disabled>Next</button>
                        </div>
                        
                        <div id="adminSpinner" class="spinner mt-20 mb-20" style="display: none;"></div>
                    </div>
                </div>
                
                <!-- Vehicle Status Tab -->
                <div id="vehiclesTab" class="admin-tab-content hidden">
                    <div class="admin-controls">
                        <div class="search-control filter-control">
                            <label class="form-label" for="searchVehicles">Search Vehicles</label>
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchVehicles" class="form-control" placeholder="Search by vehicle number or type">
                            </div>
                        </div>
                    </div>
                    
                    <div class="vehicle-status-cards">
                        <div class="status-card">
                            <div class="status-card-header">
                                <div class="status-card-title">Available Vehicles</div>
                                <div class="status-card-count status-card-available" id="availableCount">0</div>
                            </div>
                            <div class="selection-list" id="availableVehiclesList">
                                <!-- Available vehicles will be populated here -->
                            </div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-card-header">
                                <div class="status-card-title">Booked Vehicles</div>
                                <div class="status-card-count status-card-booked" id="bookedCount">0</div>
                            </div>
                            <div class="selection-list" id="bookedVehiclesList">
                                <!-- Booked vehicles will be populated here -->
                            </div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-card-header">
                                <div class="status-card-title">Under Maintenance</div>
                                <div class="status-card-count status-card-maintenance" id="maintenanceCount">0</div>
                            </div>
                            <div class="selection-list" id="maintenanceVehiclesList">
                                <!-- Maintenance vehicles will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Tab -->
                <div id="reportsTab" class="admin-tab-content hidden">
                    <div class="report-section">
                        <h2 class="section-title">Generate Reports</h2>
                        
                        <div class="report-controls">
                            <div class="report-control">
                                <label class="form-label" for="reportType">Report Type</label>
                                <select id="reportType" class="form-control">
                                    <option value="bookings">Booking Summary</option>
                                    <option value="vehicles">Vehicle Utilization</option>
                                    <option value="drivers">Driver Assignments</option>
                                    <option value="monthly">Monthly Summary</option>
                                </select>
                            </div>
                            
                            <div class="report-control">
                                <label class="form-label" for="startDate">Start Date</label>
                                <input type="date" id="startDate" class="form-control">
                            </div>
                            
                            <div class="report-control">
                                <label class="form-label" for="endDate">End Date</label>
                                <input type="date" id="endDate" class="form-control">
                            </div>
                            
                            <div class="report-control">
                                <label class="form-label">&nbsp;</label>
                                <button id="generateReport" class="btn">Generate Report</button>
                            </div>
                        </div>
                        
                        <div id="reportResults"></div>
                    </div>
                </div>
                
                <!-- System Logs Tab -->
                <div id="logsTab" class="admin-tab-content hidden">
                    <div class="report-section">
                        <h2 class="section-title">System Logs</h2>
                        
                        <div class="admin-controls">
                            <div class="filter-control">
                                <label class="form-label" for="logTypeFilter">Filter by Type</label>
                                <select id="logTypeFilter" class="form-control">
                                    <option value="all">All Logs</option>
                                    <option value="booking">Booking</option>
                                    <option value="allocation">Allocation</option>
                                    <option value="system">System</option>
                                </select>
                            </div>
                            <div class="filter-control">
                                <label class="form-label" for="userFilter">Filter by User</label>
                                <select id="userFilter" class="form-control">
                                    <option value="all">All Users</option>
                                    <!-- User options will be populated here -->
                                </select>
                            </div>
                            <div class="search-control filter-control">
                                <label class="form-label" for="searchLogs">Search Logs</label>
                                <div class="search-container">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchLogs" class="form-control" placeholder="Search logs...">
                                </div>
                            </div>
                        </div>
                        
                        <div class="data-table-container">
                            <div class="data-table-header">
                                <div class="data-table-title">System Activity Log</div>
                                <div class="data-table-controls">
                                    <button id="refreshLogs" class="btn btn-secondary">Refresh</button>
                                    <button id="exportLogs" class="btn">Export</button>
                                </div>
                            </div>
                            <div class="table-scroll-container">
                                <table class="user-vehicle-table">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>Type</th>
                                            <th>User</th>
                                            <th>Action</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="systemLogsTable">
                                        <!-- Logs will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination">
                                <button id="logsPrevPage" disabled>Previous</button>
                                <span class="pagination-info" id="logsPageInfo">Page 1 of 1</span>
                                <button id="logsNextPage" disabled>Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Allocation Modal -->
    <div id="allocationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Allocate Vehicle & Driver</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="uniquePassword">Booking Password *</label>
                    <input type="password" id="uniquePassword" class="form-control" placeholder="Enter booking password for verification" required>
                    <small class="form-text">Enter the unique password provided for this booking</small>
                </div>
                
                <div class="form-section">
                    <h4 class="section-title">Select Vehicle</h4>
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchVehicleModal" class="form-control" placeholder="Search vehicles...">
                    </div>
                    <div class="selection-list" id="vehicleSelectionList">
                        <!-- Vehicles will be populated here -->
                    </div>
                    <div class="pagination">
                        <button id="vehiclePrevPage" disabled>Previous</button>
                        <span class="pagination-info" id="vehiclePageInfo">Page 1 of 1</span>
                        <button id="vehicleNextPage" disabled>Next</button>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4 class="section-title">Select Driver</h4>
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchDriverModal" class="form-control" placeholder="Search drivers...">
                    </div>
                    <div class="selection-list" id="driverSelectionList">
                        <!-- Drivers will be populated here -->
                    </div>
                    <div class="pagination">
                        <button id="driverPrevPage" disabled>Previous</button>
                        <span class="pagination-info" id="driverPageInfo">Page 1 of 1</span>
                        <button id="driverNextPage" disabled>Next</button>
                    </div>
                </div>

                <!-- NEW: Fuel Station Input -->
                <div class="form-section">
                    <h4 class="section-title">Fuel Station Details</h4>
                    <div class="form-group">
                        <label class="form-label" for="fuelStation">Nominated Fuel Station *</label>
                        <input type="text" id="fuelStation" class="form-control" placeholder="Enter nominated fuel station" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="extraFuel">Extra Fuel (Liters) *</label>
                        <input type="number" id="extraFuel" class="form-control" placeholder="Enter amount of extra fuel in liters" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Selected Allocation:</label>
                    <div id="selectedAllocation" class="enhanced-pdf-section">
                        <div><strong>Vehicle:</strong> <span id="selectedVehicleText">None selected</span></div>
                        <div><strong>Driver:</strong> <span id="selectedDriverText">None selected</span></div>
                        <div><strong>Fuel Station:</strong> <span id="selectedFuelStationText">None selected</span></div>
                        <div><strong>Extra Fuel:</strong> <span id="selectedExtraFuelText">None specified</span></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelAllocation" class="btn btn-danger">Cancel</button>
                <button id="confirmAllocation" class="btn">Allocate</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Booking Request</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editUserName">Full Name</label>
                            <input type="text" id="editUserName" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editUserDesignation">Designation</label>
                            <input type="text" id="editUserDesignation" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editUserBranch">Branch/Section</label>
                            <input type="text" id="editUserBranch" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editUserPhone">Phone</label>
                            <input type="tel" id="editUserPhone" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editApprovedBy">Approved By</label>
                            <input type="text" id="editApprovedBy" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editPurpose">Purpose</label>
                            <textarea id="editPurpose" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editSeatCount">Seat Count</label>
                            <select id="editSeatCount" class="form-control">
                                <option value="4">4 Seater</option>
                                <option value="7">7 Seater</option>
                                <option value="15">15+ Seater</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editDistance">Approximate Distance (KM)</label>
                            <input type="number" id="editDistance" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editStartDateTime">Start Date/Time</label>
                            <input type="datetime-local" id="editStartDateTime" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editEndDateTime">End Date/Time</label>
                            <input type="datetime-local" id="editEndDateTime" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editStartLocation">Start Location</label>
                            <input type="text" id="editStartLocation" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editDestination">Destination</label>
                            <input type="text" id="editDestination" class="form-control">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelEdit" class="btn btn-danger">Cancel</button>
                <button id="confirmEdit" class="btn">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- View Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Booking Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="enhanced-pdf">
                    <div class="enhanced-pdf-header">
                        <div class="enhanced-pdf-title">Ministry of Health</div>
                        <div class="enhanced-pdf-subtitle">Vehicle Booking Details</div>
                    </div>
                    <div class="enhanced-pdf-grid">
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Booking Reference:</div>
                            <div class="enhanced-pdf-value" id="viewRefNumber"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Submission Date:</div>
                            <div class="enhanced-pdf-value" id="viewDate"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Requestor Details:</div>
                            <div class="enhanced-pdf-value" id="viewUserDetails"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Branch/Section:</div>
                            <div class="enhanced-pdf-value" id="viewBranch"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Approved By:</div>
                            <div class="enhanced-pdf-value" id="viewApprovedBy"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Trip Details:</div>
                            <div class="enhanced-pdf-value" id="viewTripDetails"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Vehicle Requirements:</div>
                            <div class="enhanced-pdf-value" id="viewVehicleReq"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Approximate Distance:</div>
                            <div class="enhanced-pdf-value" id="viewDistance"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Status:</div>
                            <div class="enhanced-pdf-value" id="viewStatus"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Allocated Vehicle:</div>
                            <div class="enhanced-pdf-value" id="viewVehicle"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Allocated Driver:</div>
                            <div class="enhanced-pdf-value" id="viewDriver"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Fuel Station:</div>
                            <div class="enhanced-pdf-value" id="viewFuelStation"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Extra Fuel:</div>
                            <div class="enhanced-pdf-value" id="viewExtraFuel"></div>
                        </div>
                    </div>
                    <div class="qrcode-container">
                        <div id="qrCodeAdmin" class="qrcode"></div>
                    </div>
                    <div class="signature-section">
                        <div class="signature-line"></div>
                        <div class="signature-label">Approval Signature:</div>
                        <div class="signature-name">_________________________</div>
                        <div class="signature-title">Head of Department / Deputy Director General</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeView" class="btn">Close</button>
                <button id="downloadFinalPdf" class="btn btn-secondary">Download PDF</button>
                <button id="downloadGatePass" class="btn">Download Gate Pass QR</button>
                <button id="sendWhatsAppAdmin" class="btn whatsapp-btn">
                    <i class="fab fa-whatsapp"></i> Send via WhatsApp
                </button>
            </div>
        </div>
    </div>

    <script>

// Google Apps Script Web App URL
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyL1HVfeUrbeOsx_ZbDMt3u4W14EfQn55GA-bkfPnZwgT8sG8Hggz_JjpT8OQGcu6xqkg/exec';

// Global variables
let currentUserRole = 'user';
let currentUserId = null;
let currentBookingId = null;
let currentBookingRef = null;
let currentPage = 1;
const itemsPerPage = 10;
let allBookings = [];
let filteredBookings = [];
let vehicles = [];
let drivers = [];
let systemLogs = [];

// Pagination variables
let userVehiclePage = 1;
let userVehicleItemsPerPage = 15;
let filteredUserVehicles = [];

let myRequestsPage = 1;
let myRequestsItemsPerPage = 10;
let filteredMyRequests = [];

let vehicleModalPage = 1;
let driverModalPage = 1;
let modalItemsPerPage = 8;
let filteredModalVehicles = [];
let filteredModalDrivers = [];

let logsPage = 1;
let logsItemsPerPage = 15;
let filteredLogs = [];

// Selected items for allocation
let selectedVehicleId = null;
let selectedDriverId = null;
let selectedFuelStation = '';
let selectedExtraFuel = '';

// User accounts
const userAccounts = {
    'dhi': { name: 'Director (Health Information)', password: 'dhi123' },
    'da1': { name: 'Director Administration I', password: 'da1123' },
    'dna2': { name: 'Director Nursing Admin II', password: 'dna2123' },
    'da2t': { name: 'Director Admin II (Technical)', password: 'da2t123' },
    'da3nta': { name: 'Director Admin III (NTA)', password: 'da3nta123' },
    'da4': { name: 'Director Admin IV', password: 'da4123' },
    'da5': { name: 'Director Admin V', password: 'da5123' },
    'da6': { name: 'Director Admin VI', password: 'da6123' },
    'da7': { name: 'Director Admin VII', password: 'da7123' },
    'daex': { name: 'Director Admin (Exam)', password: 'daex123' },
    'dt': { name: 'Director (Transport)', password: 'dt123' },
    'dds': { name: 'Director Dental Services', password: 'dds123' },
    'dtr': { name: 'Director Training', password: 'dtr123' },
    'dre': { name: 'Director Research', password: 'dre123' },
    'dne': { name: 'Director Nursing (Education)', password: 'dne123' },
    'cas': { name: 'Chief Accountant (Stock)', password: 'cas123' },
    'cab': { name: 'Chief Accountant (Book)', password: 'cab123' },
    'cac': { name: 'Chief Accountant (Care)', password: 'cac123' },
    'ae1': { name: 'Accountant (Expenditure) I', password: 'ae1123' },
    'ae2': { name: 'Accountant (Expenditure) II', password: 'ae2123' },
    'ae3': { name: 'Accountant (Expenditure) III', password: 'ae3123' },
    'as': { name: 'Accountant (Supplies)', password: 'as123' },
    'di1': { name: 'Director Investigation I', password: 'di1123' },
    'di2': { name: 'Director Investigation II', password: 'di2123' },
    'dls': { name: 'Director Laboratory Services', password: 'dls123' },
    'dba': { name: 'Director Buildings (Admin)', password: 'dba123' },
    'dbe': { name: 'Director Buildings (Engineering)', password: 'dbe123' },
    'dp': { name: 'Director Planning', password: 'dp123' },
    'dod': { name: 'Director Organization & Dev', password: 'dod123' },
    'dih': { name: 'Director International Health', password: 'dih123' },
    'dpa': { name: 'Director Policy Analysis', password: 'dpa123' },
    'dsu': { name: 'Director Statistics Unit', password: 'dsu123' },
    'afp': { name: 'Accountant Finance (Planning)', password: 'afp123' },
    'dam1': { name: 'Director Admin Medical I', password: 'dam1123' },
    'dam2': { name: 'Director Admin Medical II', password: 'dam2123' },
    'dms': { name: 'Director Medical Services', password: 'dms123' },
    'dtc': { name: 'Director Tertiary Care', password: 'dtc123' },
    'dpc': { name: 'Director Primary Care', password: 'dpc123' },
    'dph': { name: 'Director Private Health', password: 'dph123' },
    'dnm': { name: 'Director Nursing (Medical)', password: 'dnm123' },
    'dqs': { name: 'Director Quality & Safety', password: 'dqs123' },
    'dncd': { name: 'Director NCD', password: 'dncd123' },
    'dmh': { name: 'Director Mental Health', password: 'dmh123' },
    'dfs': { name: 'Director Food Safety', password: 'dfs123' },
    'deu': { name: 'Director Estate & Urban Health', password: 'deu123' },
    'dq': { name: 'Director Quarantine', password: 'dq123' },
    'dve': { name: 'Director Youth/Elderly/Disabled', password: 'dve123' },
    'dnp': { name: 'Director Nursing (Public Health)', password: 'dnp123' },
    'ddgp': { name: 'DDG Planning', password: 'ddgp123' },
    'ddga1': { name: 'DDG Admin I', password: 'ddga1123' },
    'ddga2': { name: 'DDG Admin II', password: 'ddga2123' },
    'ddga3': { name: 'DDG Admin III', password: 'ddga3123' },
    'ddgd': { name: 'DDG Dental Services', password: 'ddgd123' },
    'ddger': { name: 'DDG Education/Research', password: 'ddger123' },
    'ddgi': { name: 'DDG Investigation', password: 'ddgi123' },
    'ddgl': { name: 'DDG Lab Services', password: 'ddgl123' },
    'ddglog': { name: 'DDG Logistics', password: 'ddglog123' },
    'ddgm1': { name: 'DDG Medical Services I', password: 'ddgm1123' },
    'ddgm2': { name: 'DDG Medical Services II', password: 'ddgm2123' },
    'ddgph1': { name: 'DDG Public Health I', password: 'ddgph1123' },
    'ddgph2': { name: 'DDG Public Health II', password: 'ddgph2123' },
    'ddgncd': { name: 'DDG NCD', password: 'ddgncd123' },
    'ddgeh': { name: 'DDG Env & Health Safety', password: 'ddgeh123' },
    'sasadm': { name: 'Senior Asst Sec Admin', password: 'sasadm123' },
    'sasfs': { name: 'Senior Asst Sec Flying Squad', password: 'sasfs123' },
    'sasp': { name: 'Senior Asst Sec Info', password: 'sasp123' },
    'sasmed': { name: 'Senior Asst Sec Medical', password: 'sasmed123' },
    'sasp1': { name: 'Senior Asst Sec Procurement I', password: 'sasp1123' },
    'sasp2': { name: 'Senior Asst Sec Procurement II', password: 'sasp2123' },
    'sasdev': { name: 'Senior Asst Sec Development', password: 'sasdev123' },
    'dgh': { name: 'Director General Health', password: 'dgh123' },
    'asa1': { name: 'Add Sec Admin I', password: 'asa1123' },
    'asa2': { name: 'Add Sec Admin II', password: 'asa2123' },
    'asdev': { name: 'Add Sec Development', password: 'asdev123' },
    'asmed': { name: 'Add Sec Medical', password: 'asmed123' },
    'asph': { name: 'Add Sec Public Health', password: 'asph123' },
    'asproc': { name: 'Add Sec Procurement', password: 'asproc123' },
    'aseng': { name: 'Add Sec Engineering', password: 'aseng123' },
    'cfo1': { name: 'Chief Finance Officer I', password: 'cfo1123' },
    'cfo2': { name: 'Chief Finance Officer II', password: 'cfo2123' },
    'cfo3': { name: 'Chief Finance Officer III', password: 'cfo3123' },
    'soh': { name: 'Secretary of Health', password: 'soh123' }
};

// Initialize localStorage if not exists
function initializeLocalStorage() {
    if (!localStorage.getItem('bookings')) {
        localStorage.setItem('bookings', JSON.stringify([]));
    }
    if (!localStorage.getItem('vehicles')) {
        const sampleVehicles = [];
        const vehicleTypes = [
            { type: '4 Seater', capacity: '4' },
            { type: '7 Seater', capacity: '7' },
            { type: '15+ Seater', capacity: '15' }
        ];
        
        for (let i = 1; i <= 50; i++) {
            const vehicleType = vehicleTypes[Math.floor(Math.random() * vehicleTypes.length)];
            const statuses = ['Available', 'Booked', 'Maintenance'];
            const status = statuses[Math.floor(Math.random() * statuses.length)];
            
            sampleVehicles.push({
                id: i,
                vehicleno: `V${i.toString().padStart(3, '0')}`,
                type: vehicleType.type,
                seatcapacity: vehicleType.capacity,
                status: status
            });
        }
        localStorage.setItem('vehicles', JSON.stringify(sampleVehicles));
    }
    if (!localStorage.getItem('drivers')) {
        const sampleDrivers = [];
        const firstNames = ['John', 'Jane', 'Robert', 'Sarah', 'Michael', 'Emily', 'David', 'Lisa', 'James', 'Maria'];
        const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez'];
        
        for (let i = 1; i <= 30; i++) {
            const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
            const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
            const statuses = ['Available', 'Assigned', 'On Leave'];
            const status = statuses[Math.floor(Math.random() * statuses.length)];
            
            sampleDrivers.push({
                id: i,
                name: `${firstName} ${lastName}`,
                phone: `07${Math.floor(10000000 + Math.random() * 90000000)}`,
                status: status
            });
        }
        localStorage.setItem('drivers', JSON.stringify(sampleDrivers));
    }
    if (!localStorage.getItem('systemLogs')) {
        localStorage.setItem('systemLogs', JSON.stringify([]));
    }
}

// Utility Functions
function formatDateTime(dateTimeString) {
    if (!dateTimeString) return 'N/A';
    const date = new Date(dateTimeString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    return new Date(dateString).toLocaleDateString();
}

function showElement(element, show = true) {
    if (element) {
        element.style.display = show ? 'block' : 'none';
    }
}

function showMessage(message, type = 'error') {
    const loginMessage = document.getElementById('loginMessage');
    loginMessage.textContent = message;
    loginMessage.style.color = type === 'error' ? 'var(--danger)' : 'var(--success)';
    showElement(loginMessage);
    setTimeout(() => showElement(loginMessage, false), 5000);
}

function generateUniquePassword() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let password = '';
    for (let i = 0; i < 6; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
}

// System Logging Function
function logSystemActivity(type, user, action, details = '') {
    const log = {
        timestamp: new Date().toISOString(),
        type: type,
        user: user,
        action: action,
        details: details
    };
    
    const logs = JSON.parse(localStorage.getItem('systemLogs') || '[]');
    logs.unshift(log);
    if (logs.length > 1000) logs.pop();
    localStorage.setItem('systemLogs', JSON.stringify(logs));
    
    systemLogs = logs;
    
    const logsTab = document.getElementById('logsTab');
    if (logsTab && !logsTab.classList.contains('hidden')) {
        filterLogs();
    }
}

// Update pending booking notification
function updatePendingBookingNotification() {
    const pendingBookingBadge = document.getElementById('pendingBookingBadge');
    const pendingCount = allBookings.filter(booking => booking.status === 'Pending').length;
    if (pendingCount > 0) {
        pendingBookingBadge.textContent = pendingCount;
        pendingBookingBadge.style.display = 'flex';
    } else {
        pendingBookingBadge.style.display = 'none';
    }
}

// API Functions
async function callGoogleAppsScript(action, data = {}) {
    try {
        const formData = new URLSearchParams();
        formData.append('action', action);
        
        for (const [key, value] of Object.entries(data)) {
            formData.append(key, value);
        }

        const response = await fetch(GAS_WEB_APP_URL, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        return result;
    } catch (error) {
        console.error('API call failed:', error);
        return getMockData(action, data);
    }
}

// Enhanced Mock Data
function getMockData(action, data) {
    switch(action) {
        case 'login':
            if (data.role === 'admin' && data.password === 'TB005') {
                logSystemActivity('system', 'Administrator', 'Login', 'Main admin login successful');
                return { success: true, message: 'Login successful', role: 'mainadmin' };
            }
            if (data.role === 'user' && data.userId && userAccounts[data.userId] && data.password === userAccounts[data.userId].password) {
                logSystemActivity('system', 'User', 'Login', `User ${data.userId} login successful`);
                return { success: true, message: 'Login successful', userName: userAccounts[data.userId].name, userId: data.userId };
            }
            return { success: false, error: 'Invalid credentials' };
        
        case 'submitBooking':
            const refNumber = 'VBS-' + new Date().getFullYear() + '-' + Math.floor(1000 + Math.random() * 9000);
            const uniquePassword = generateUniquePassword();
            
            const booking = {
                id: Date.now(),
                refnumber: refNumber,
                username: data.userName,
                userdesignation: data.userDesignation,
                userbranch: data.userBranch,
                userphone: data.userPhone,
                approvedby: data.approvedBy,
                purpose: data.purpose,
                seatcount: data.seatCount,
                distance: data.distance,
                goodstransport: data.goodsTransport ? 'Yes' : 'No',
                startdatetime: data.startDateTime,
                enddatetime: data.endDateTime,
                startlocation: data.startLocation,
                destination: data.destination,
                status: 'Pending',
                allocatedvehicle: '',
                allocateddriver: '',
                fuelstation: '',
                extrafuel: '',
                timestamp: new Date().toISOString(),
                uniquepassword: uniquePassword,
                userId: data.userId
            };
            
            let bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
            bookings.push(booking);
            localStorage.setItem('bookings', JSON.stringify(bookings));
            
            logSystemActivity('booking', data.userName, 'Booking Submitted', `Ref: ${refNumber}`);
            
            return {
                success: true,
                message: 'Booking submitted successfully',
                bookingId: booking.id,
                refNumber: refNumber,
                uniquePassword: uniquePassword
            };
        
        case 'getBookings':
            const storedBookings = JSON.parse(localStorage.getItem('bookings') || '[]');
            return { bookings: storedBookings };
        
        case 'getVehicles':
            const storedVehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
            return { vehicles: storedVehicles };
        
        case 'getDrivers':
            const storedDrivers = JSON.parse(localStorage.getItem('drivers') || '[]');
            return { drivers: storedDrivers };
        
        case 'allocateVehicle':
            let allBookingsData = JSON.parse(localStorage.getItem('bookings') || '[]');
            let allVehiclesData = JSON.parse(localStorage.getItem('vehicles') || '[]');
            let allDriversData = JSON.parse(localStorage.getItem('drivers') || '[]');
            
            const bookingIndex = allBookingsData.findIndex(b => b.id == data.bookingId);
            
            if (bookingIndex === -1) {
                return { success: false, error: 'Booking not found' };
            }
            
            const storedPassword = allBookingsData[bookingIndex].uniquepassword;
            const enteredPassword = data.uniquePassword;
            
            if (!storedPassword || !enteredPassword) {
                return { success: false, error: 'Password is required' };
            }
            
            if (storedPassword.toUpperCase() !== enteredPassword.toUpperCase()) {
                return { success: false, error: 'Invalid booking password. Please check and try again.' };
            }
            
            const vehicleIndex = allVehiclesData.findIndex(v => v.id == data.vehicleId);
            const driverIndex = allDriversData.findIndex(d => d.id == data.driverId);
            
            if (vehicleIndex === -1 || driverIndex === -1) {
                return { success: false, error: 'Vehicle or driver not found' };
            }
            
            allBookingsData[bookingIndex].allocatedvehicle = `${allVehiclesData[vehicleIndex].vehicleno} - ${allVehiclesData[vehicleIndex].type}`;
            allBookingsData[bookingIndex].allocateddriver = `${allDriversData[driverIndex].name} (${allDriversData[driverIndex].phone})`;
            allBookingsData[bookingIndex].fuelstation = data.fuelStation;
            allBookingsData[bookingIndex].extrafuel = data.extraFuel;
            allBookingsData[bookingIndex].status = 'Approved';
            
            allVehiclesData[vehicleIndex].status = 'Booked';
            allDriversData[driverIndex].status = 'Assigned';
            
            localStorage.setItem('bookings', JSON.stringify(allBookingsData));
            localStorage.setItem('vehicles', JSON.stringify(allVehiclesData));
            localStorage.setItem('drivers', JSON.stringify(allDriversData));
            
            logSystemActivity('allocation', 'Administrator', 'Vehicle Allocated', 
                `Booking: ${allBookingsData[bookingIndex].refnumber}, Vehicle: ${allVehiclesData[vehicleIndex].vehicleno}, Driver: ${allDriversData[driverIndex].name}`);
            
            return { success: true, message: 'Vehicle and driver allocated successfully' };
        
        case 'editBooking':
            let editBookings = JSON.parse(localStorage.getItem('bookings') || '[]');
            const editIndex = editBookings.findIndex(b => b.id == data.bookingId);
            
            if (editIndex === -1) {
                return { success: false, error: 'Booking not found' };
            }
            
            editBookings[editIndex].username = data.userName;
            editBookings[editIndex].userdesignation = data.userDesignation;
            editBookings[editIndex].userbranch = data.userBranch;
            editBookings[editIndex].userphone = data.userPhone;
            editBookings[editIndex].approvedby = data.approvedBy;
            editBookings[editIndex].purpose = data.purpose;
            editBookings[editIndex].seatcount = data.seatCount;
            editBookings[editIndex].distance = data.distance;
            editBookings[editIndex].startdatetime = data.startDateTime;
            editBookings[editIndex].enddatetime = data.endDateTime;
            editBookings[editIndex].startlocation = data.startLocation;
            editBookings[editIndex].destination = data.destination;
            
            localStorage.setItem('bookings', JSON.stringify(editBookings));
            
            logSystemActivity('booking', 'Administrator', 'Booking Updated', `Ref: ${editBookings[editIndex].refnumber}`);
            
            return { success: true, message: 'Booking updated successfully' };
        
        case 'deleteBooking':
            let deleteBookings = JSON.parse(localStorage.getItem('bookings') || '[]');
            const deleteIndex = deleteBookings.findIndex(b => b.id == data.bookingId);
            
            if (deleteIndex === -1) {
                return { success: false, error: 'Booking not found' };
            }
            
            const deletedRef = deleteBookings[deleteIndex].refnumber;
            deleteBookings.splice(deleteIndex, 1);
            localStorage.setItem('bookings', JSON.stringify(deleteBookings));
            
            logSystemActivity('booking', 'Administrator', 'Booking Deleted', `Ref: ${deletedRef}`);
            
            return { success: true, message: 'Booking deleted successfully' };
        
        case 'getReports':
            const reportBookings = JSON.parse(localStorage.getItem('bookings') || '[]');
            const reportVehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
            const reportDrivers = JSON.parse(localStorage.getItem('drivers') || '[]');
            
            let filteredData = reportBookings;
            
            if (data.startDate && data.endDate) {
                const startTimestamp = new Date(data.startDate).getTime();
                const endTimestamp = new Date(data.endDate).getTime() + 86400000;
                
                filteredData = reportBookings.filter(booking => {
                    const bookingTime = new Date(booking.timestamp).getTime();
                    return bookingTime >= startTimestamp && bookingTime < endTimestamp;
                });
            }
            
            let reportData = [];
            let title = '';
            
            switch(data.type) {
                case 'bookings':
                    title = 'Booking Summary Report';
                    reportData = [['Booking Ref', 'Requester', 'Branch', 'Destination', 'Status', 'Vehicle', 'Date']];
                    filteredData.forEach(booking => {
                        reportData.push([
                            booking.refnumber,
                            booking.username,
                            booking.userbranch,
                            booking.destination,
                            booking.status,
                            booking.allocatedvehicle || 'Not allocated',
                            formatDate(booking.timestamp)
                        ]);
                    });
                    break;
                    
                case 'vehicles':
                    title = 'Vehicle Utilization Report';
                    reportData = [['Vehicle No', 'Type', 'Capacity', 'Status', 'Current Booking']];
                    reportVehicles.forEach(vehicle => {
                        const currentBooking = reportBookings.find(b => 
                            b.allocatedvehicle && b.allocatedvehicle.includes(vehicle.vehicleno) && 
                            b.status === 'Approved'
                        );
                        reportData.push([
                            vehicle.vehicleno,
                            vehicle.type,
                            vehicle.seatcapacity + ' seats',
                            vehicle.status,
                            currentBooking ? currentBooking.refnumber : '-'
                        ]);
                    });
                    break;
                    
                case 'drivers':
                    title = 'Driver Assignments Report';
                    reportData = [['Driver Name', 'Phone', 'Status', 'Current Assignment']];
                    reportDrivers.forEach(driver => {
                        const currentBooking = reportBookings.find(b => 
                            b.allocateddriver && b.allocateddriver.includes(driver.name) && 
                            b.status === 'Approved'
                        );
                        reportData.push([
                            driver.name,
                            driver.phone,
                            driver.status,
                            currentBooking ? currentBooking.refnumber : '-'
                        ]);
                    });
                    break;
                    
                case 'monthly':
                    title = 'Monthly Summary Report';
                    const monthlyData = {};
                    
                    filteredData.forEach(booking => {
                        const monthYear = new Date(booking.timestamp).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                        if (!monthlyData[monthYear]) {
                            monthlyData[monthYear] = { total: 0, pending: 0, approved: 0, rejected: 0, completed: 0 };
                        }
                        monthlyData[monthYear].total++;
                        monthlyData[monthYear][booking.status.toLowerCase()]++;
                    });
                    
                    reportData = [['Month', 'Total', 'Pending', 'Approved', 'Rejected', 'Completed']];
                    Object.keys(monthlyData).forEach(month => {
                        const data = monthlyData[month];
                        reportData.push([
                            month,
                            data.total.toString(),
                            data.pending.toString(),
                            data.approved.toString(),
                            data.rejected.toString(),
                            data.completed.toString()
                        ]);
                    });
                    break;
                    
                default:
                    title = 'Booking Summary Report';
                    reportData = [['Booking Ref', 'Requester', 'Destination', 'Status', 'Vehicle']];
                    filteredData.forEach(booking => {
                        reportData.push([
                            booking.refnumber,
                            booking.username,
                            booking.destination,
                            booking.status,
                            booking.allocatedvehicle || 'Not allocated'
                        ]);
                    });
            }
            
            return {
                success: true,
                title: title,
                generatedAt: new Date().toISOString(),
                reportData: reportData
            };
        
        case 'getSystemLogs':
            const logs = JSON.parse(localStorage.getItem('systemLogs') || '[]');
            return { logs: logs };
        
        default:
            return { success: false, error: 'Unknown action' };
    }
}

// Authentication Functions
async function handleLogin() {
    const userSelect = document.getElementById('userSelect');
    const passwordInput = document.getElementById('password');
    const loginSpinner = document.getElementById('loginSpinner');
    const loginBtn = document.getElementById('loginBtn');
    
    const userId = userSelect.value;
    const password = passwordInput.value.trim();
    
    if (currentUserRole === 'user' && !userId) {
        showMessage('Please select a user');
        return;
    }
    
    if (!password) {
        showMessage('Please enter a password');
        return;
    }

    showElement(loginSpinner);
    loginBtn.disabled = true;

    try {
        const result = await callGoogleAppsScript('login', {
            role: currentUserRole,
            userId: userId,
            password: password
        });

        if (result.success) {
            showElement(document.getElementById('loginScreen'), false);
            if (currentUserRole === 'user') {
                currentUserId = userId;
                showElement(document.getElementById('userDashboard'));
                document.getElementById('userDisplayName').textContent = result.userName || 'Staff Member';
                resetBookingForm();
                updateUserVehicleStatus();
                loadMyRequests();
            } else {
                showElement(document.getElementById('adminDashboard'));
                document.getElementById('adminDisplayName').textContent = 
                    result.role === 'mainadmin' ? 'Main Administrator' : 'Administrator';
                loadAdminData();
                loadSystemLogs();
            }
        } else {
            showMessage(result.error || 'Invalid password');
        }
    } catch (error) {
        showMessage('Login failed. Please try again.');
    } finally {
        showElement(loginSpinner, false);
        loginBtn.disabled = false;
    }
}

function logout() {
    logSystemActivity('system', currentUserRole === 'user' ? 'User' : 'Administrator', 'Logout');
    showElement(document.getElementById('userDashboard'), false);
    showElement(document.getElementById('adminDashboard'), false);
    showElement(document.getElementById('loginScreen'));
    document.getElementById('password').value = '';
    document.getElementById('userSelect').value = '';
    showElement(document.getElementById('loginMessage'), false);
    currentUserId = null;
}

// Booking Functions
async function submitBooking() {
    const requiredFields = ['userName', 'userDesignation', 'userBranch', 'userPhone', 'approvedBy', 'purpose', 'seatCount', 'distance', 'startDateTime', 'endDateTime', 'startLocation', 'destination'];
    
    for (const fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            alert(`Please fill in the ${field.previousElementSibling.textContent}`);
            field.focus();
            return;
        }
    }

    const startDateTime = new Date(document.getElementById('startDateTime').value);
    const endDateTime = new Date(document.getElementById('endDateTime').value);
    
    if (startDateTime >= endDateTime) {
        alert('End date and time must be after start date and time');
        return;
    }

    if (startDateTime < new Date()) {
        alert('Start date and time cannot be in the past');
        return;
    }

    const bookingData = {
        userName: document.getElementById('userName').value.trim(),
        userDesignation: document.getElementById('userDesignation').value.trim(),
        userBranch: document.getElementById('userBranch').value.trim(),
        userPhone: document.getElementById('userPhone').value.trim(),
        approvedBy: document.getElementById('approvedBy').value.trim(),
        purpose: document.getElementById('purpose').value.trim(),
        seatCount: document.getElementById('seatCount').value,
        distance: document.getElementById('distance').value,
        goodsTransport: document.getElementById('goodsTransport').checked,
        startDateTime: document.getElementById('startDateTime').value,
        endDateTime: document.getElementById('endDateTime').value,
        startLocation: document.getElementById('startLocation').value.trim(),
        destination: document.getElementById('destination').value.trim(),
        userId: currentUserId
    };

    const submitBookingBtn = document.getElementById('submitBooking');
    const submitSpinner = document.getElementById('submitSpinner');
    submitBookingBtn.disabled = true;
    showElement(submitSpinner);

    try {
        const result = await callGoogleAppsScript('submitBooking', bookingData);
        
        if (result.success) {
            currentBookingId = result.bookingId;
            currentBookingRef = result.refNumber;
            updateBookingConfirmation(result, bookingData);
            showElement(document.getElementById('bookingForm'), false);
            showElement(document.getElementById('bookingSuccess'));
            
            if (document.getElementById('adminDashboard').style.display === 'block') {
                loadAdminData();
            }
            
            loadMyRequests();
        } else {
            alert('Booking submission failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Booking submission failed. Please try again.');
    } finally {
        submitBookingBtn.disabled = false;
        showElement(submitSpinner, false);
    }
}

function updateBookingConfirmation(result, data) {
    document.getElementById('enhancedPdfRefNumber').textContent = result.refNumber;
    document.getElementById('enhancedPdfPassword').textContent = result.uniquePassword;
    document.getElementById('enhancedPdfDate').textContent = new Date().toLocaleDateString();
    document.getElementById('enhancedPdfUserDetails').textContent = 
        `${data.userName}, ${data.userDesignation}, ${data.userPhone}`;
    document.getElementById('enhancedPdfBranch').textContent = data.userBranch;
    document.getElementById('enhancedPdfApprovedBy').textContent = data.approvedBy;
    document.getElementById('enhancedPdfTripDetails').textContent = 
        `${data.purpose}. From ${data.startLocation} to ${data.destination}. ${formatDateTime(data.startDateTime)} to ${formatDateTime(data.endDateTime)}`;
    document.getElementById('enhancedPdfVehicleReq').textContent = 
        `${data.seatCount} seats, Goods Transport: ${data.goodsTransport ? 'Yes' : 'No'}`;
    document.getElementById('enhancedPdfDistance').textContent = 
        `${data.distance} KM`;
    document.getElementById('uniquePasswordDisplay').textContent = result.uniquePassword;
        
    generateQRCode(result.refNumber, data.startDateTime, data.endDateTime, 'qrCodeUser', '', result.uniquePassword);
}

function resetBookingForm() {
    const fields = ['userName', 'userDesignation', 'userBranch', 'userPhone', 'approvedBy', 'purpose', 'seatCount', 'distance', 'startDateTime', 'endDateTime', 'startLocation', 'destination'];
    fields.forEach(id => {
        const field = document.getElementById(id);
        if (field) field.value = '';
    });
    
    const goodsCheckbox = document.getElementById('goodsTransport');
    if (goodsCheckbox) goodsCheckbox.checked = false;
    
    showElement(document.getElementById('bookingForm'));
    showElement(document.getElementById('bookingSuccess'), false);
}

// User My Requests Functions
async function loadMyRequests() {
    try {
        const bookingsResult = await callGoogleAppsScript('getBookings');
        const myBookings = bookingsResult.bookings.filter(booking => booking.userId === currentUserId) || [];
        filteredMyRequests = myBookings;
        displayMyRequests();
        updateMyRequestsPagination();
    } catch (error) {
        console.error('Error loading my requests:', error);
    }
}

function filterMyRequests() {
    const status = document.getElementById('myRequestsStatusFilter').value;
    const searchTerm = document.getElementById('searchMyRequests').value.toLowerCase();
    
    let myBookings = allBookings.filter(booking => booking.userId === currentUserId);
    
    filteredMyRequests = myBookings.filter(booking => {
        const statusMatch = status === 'all' || booking.status === status;
        const searchMatch = !searchTerm || 
            booking.refnumber.toLowerCase().includes(searchTerm) ||
            booking.destination.toLowerCase().includes(searchTerm);
        
        return statusMatch && searchMatch;
    });
    
    myRequestsPage = 1;
    displayMyRequests();
    updateMyRequestsPagination();
}

function displayMyRequests() {
    const myRequestsTableBody = document.getElementById('myRequestsTableBody');
    const myRequestCount = document.getElementById('myRequestCount');
    myRequestsTableBody.innerHTML = '';
    
    if (filteredMyRequests.length === 0) {
        myRequestsTableBody.innerHTML = '<tr><td colspan="7" class="text-center">No booking requests found</td></tr>';
        myRequestCount.textContent = '0 requests';
        return;
    }

    const startIndex = (myRequestsPage - 1) * myRequestsItemsPerPage;
    const endIndex = Math.min(startIndex + myRequestsItemsPerPage, filteredMyRequests.length);
    const currentRequests = filteredMyRequests.slice(startIndex, endIndex);

    myRequestCount.textContent = `${filteredMyRequests.length} requests`;

    currentRequests.forEach(booking => {
        const row = document.createElement('tr');
        if (booking.status === 'Pending') {
            row.classList.add('highlighted-row');
        }

        const statusClass = `status-${booking.status.toLowerCase()}`;
        
        row.innerHTML = `
            <td>${booking.refnumber}</td>
            <td>${booking.destination}</td>
            <td>${formatDateTime(booking.startdatetime)}</td>
            <td>${booking.seatcount}</td>
            <td>${booking.distance} KM</td>
            <td><span class="status-badge ${statusClass}">${booking.status}</span></td>
            <td>
                <button class="action-btn btn" onclick="viewMyBooking(${booking.id})">View</button>
            </td>
        `;

        myRequestsTableBody.appendChild(row);
    });
}

function updateMyRequestsPagination() {
    const totalPages = Math.ceil(filteredMyRequests.length / myRequestsItemsPerPage);
    document.getElementById('myRequestsPageInfo').textContent = `Page ${myRequestsPage} of ${totalPages}`;
    document.getElementById('myRequestsPrevPage').disabled = myRequestsPage === 1;
    document.getElementById('myRequestsNextPage').disabled = myRequestsPage === totalPages || totalPages === 0;
}

function goToMyRequestsPrevPage() {
    if (myRequestsPage > 1) {
        myRequestsPage--;
        displayMyRequests();
        updateMyRequestsPagination();
    }
}

function goToMyRequestsNextPage() {
    const totalPages = Math.ceil(filteredMyRequests.length / myRequestsItemsPerPage);
    if (myRequestsPage < totalPages) {
        myRequestsPage++;
        displayMyRequests();
        updateMyRequestsPagination();
    }
}

function viewMyBooking(bookingId) {
    currentBookingId = bookingId;
    const booking = allBookings.find(b => b.id === bookingId);
    
    if (booking) {
        document.getElementById('viewRefNumber').textContent = booking.refnumber;
        document.getElementById('viewDate').textContent = formatDate(booking.timestamp);
        document.getElementById('viewUserDetails').textContent = 
            `${booking.username}, ${booking.userdesignation}, ${booking.userphone}`;
        document.getElementById('viewBranch').textContent = booking.userbranch;
        document.getElementById('viewApprovedBy').textContent = booking.approvedby || 'Not specified';
        document.getElementById('viewTripDetails').textContent = 
            `${booking.purpose}. From ${booking.startlocation} to ${booking.destination}. ${formatDateTime(booking.startdatetime)} to ${formatDateTime(booking.enddatetime)}`;
        document.getElementById('viewVehicleReq').textContent = 
            `${booking.seatcount} seats, Goods Transport: ${booking.goodstransport || 'No'}`;
        document.getElementById('viewDistance').textContent = 
            `${booking.distance} KM`;
        document.getElementById('viewStatus').textContent = booking.status;
        document.getElementById('viewVehicle').textContent = booking.allocatedvehicle || 'Not allocated';
        document.getElementById('viewDriver').textContent = booking.allocateddriver || 'Not allocated';
        document.getElementById('viewFuelStation').textContent = booking.fuelstation || 'Not specified';
        document.getElementById('viewExtraFuel').textContent = booking.extrafuel ? `${booking.extrafuel} liters` : 'Not specified';
        
        const vehicleNumber = booking.allocatedvehicle ? booking.allocatedvehicle.split(' - ')[0] : '';
        generateQRCode(booking.refnumber, booking.startdatetime, booking.enddatetime, 'qrCodeAdmin', vehicleNumber, booking.uniquepassword);
        
        showElement(document.getElementById('viewModal'));
    }
}

// User Vehicle Status Functions
async function updateUserVehicleStatus() {
    try {
        const vehiclesResult = await callGoogleAppsScript('getVehicles');
        vehicles = vehiclesResult.vehicles || [];
        
        const available = vehicles.filter(v => v.status === 'Available').length;
        const booked = vehicles.filter(v => v.status === 'Booked').length;
        const maintenance = vehicles.filter(v => v.status === 'Maintenance').length;
        
        document.getElementById('userAvailableCount').textContent = available;
        document.getElementById('userBookedCount').textContent = booked;
        document.getElementById('userMaintenanceCount').textContent = maintenance;
        document.getElementById('userTotalVehicles').textContent = vehicles.length;
        
        filterUserVehicles();
    } catch (error) {
        console.error('Error loading user vehicle data:', error);
    }
}

function filterUserVehicles() {
    const searchTerm = document.getElementById('searchUserVehicles').value.toLowerCase();
    
    filteredUserVehicles = vehicles.filter(vehicle => {
        const searchMatch = !searchTerm || 
            vehicle.vehicleno.toLowerCase().includes(searchTerm) ||
            vehicle.type.toLowerCase().includes(searchTerm) ||
            vehicle.status.toLowerCase().includes(searchTerm);
        
        return searchMatch;
    });
    
    userVehiclePage = 1;
    displayUserVehicles();
    updateUserVehiclePagination();
}

function displayUserVehicles() {
    const userVehiclesList = document.getElementById('userVehiclesList');
    userVehiclesList.innerHTML = '';
    
    if (filteredUserVehicles.length === 0) {
        userVehiclesList.innerHTML = '<tr><td colspan="4" class="text-center">No vehicles found</td></tr>';
        return;
    }

    const startIndex = (userVehiclePage - 1) * userVehicleItemsPerPage;
    const endIndex = Math.min(startIndex + userVehicleItemsPerPage, filteredUserVehicles.length);
    const currentVehicles = filteredUserVehicles.slice(startIndex, endIndex);

    currentVehicles.forEach(vehicle => {
        const tr = document.createElement('tr');
        const typeClass = vehicle.type.includes('4') ? 'vehicle-type-car' : 
                        vehicle.type.includes('7') ? 'vehicle-type-van' : 'vehicle-type-bus';
        const statusClass = `status-${vehicle.status.toLowerCase()}`;
        
        tr.innerHTML = `
            <td>${vehicle.vehicleno}</td>
            <td><span class="vehicle-type-badge ${typeClass}">${vehicle.type}</span></td>
            <td>${vehicle.seatcapacity} seats</td>
            <td><span class="status-badge ${statusClass}">${vehicle.status}</span></td>
        `;
        userVehiclesList.appendChild(tr);
    });
}

function updateUserVehiclePagination() {
    const totalPages = Math.ceil(filteredUserVehicles.length / userVehicleItemsPerPage);
    document.getElementById('userVehiclePageInfo').textContent = `Page ${userVehiclePage} of ${totalPages}`;
    document.getElementById('userVehiclePaginationInfo').textContent = `Page ${userVehiclePage} of ${totalPages}`;
    document.getElementById('userPrevPage').disabled = userVehiclePage === 1;
    document.getElementById('userNextPage').disabled = userVehiclePage === totalPages || totalPages === 0;
}

function goToUserPrevPage() {
    if (userVehiclePage > 1) {
        userVehiclePage--;
        displayUserVehicles();
        updateUserVehiclePagination();
    }
}

function goToUserNextPage() {
    const totalPages = Math.ceil(filteredUserVehicles.length / userVehicleItemsPerPage);
    if (userVehiclePage < totalPages) {
        userVehiclePage++;
        displayUserVehicles();
        updateUserVehiclePagination();
    }
}

// Admin Functions
async function loadAdminData() {
    const adminSpinner = document.getElementById('adminSpinner');
    showElement(adminSpinner);
    
    try {
        const [bookingsResult, vehiclesResult, driversResult] = await Promise.all([
            callGoogleAppsScript('getBookings'),
            callGoogleAppsScript('getVehicles'),
            callGoogleAppsScript('getDrivers')
        ]);

        allBookings = bookingsResult.bookings || [];
        vehicles = vehiclesResult.vehicles || [];
        drivers = driversResult.drivers || [];

        updateAdminStats();
        filterBookings();
        updateVehicleStatus();
        updatePendingBookingNotification();
    } catch (error) {
        console.error('Error loading admin data:', error);
        document.getElementById('requestsTableBody').innerHTML = '<tr><td colspan="9" class="text-center">Error loading data</td></tr>';
    } finally {
        showElement(adminSpinner, false);
    }
}

function updateAdminStats() {
    document.getElementById('totalBookings').textContent = allBookings.length;
    document.getElementById('pendingBookings').textContent = allBookings.filter(b => b.status === 'Pending').length;
    document.getElementById('approvedBookings').textContent = allBookings.filter(b => b.status === 'Approved').length;
    document.getElementById('totalVehicles').textContent = vehicles.length;
}

function filterBookings() {
    const status = document.getElementById('statusFilter').value;
    const searchTerm = document.getElementById('searchBookings').value.toLowerCase();
    
    filteredBookings = allBookings.filter(booking => {
        const statusMatch = status === 'all' || booking.status === status;
        const searchMatch = !searchTerm || 
            booking.refnumber.toLowerCase().includes(searchTerm) ||
            booking.username.toLowerCase().includes(searchTerm) ||
            booking.destination.toLowerCase().includes(searchTerm) ||
            booking.userbranch.toLowerCase().includes(searchTerm);
        
        return statusMatch && searchMatch;
    });
    
    currentPage = 1;
    displayBookings();
    updatePagination();
    updateAdminStats();
}

function displayBookings() {
    const requestsTableBody = document.getElementById('requestsTableBody');
    const requestCount = document.getElementById('requestCount');
    requestsTableBody.innerHTML = '';
    
    if (filteredBookings.length === 0) {
        requestsTableBody.innerHTML = '<tr><td colspan="9" class="text-center">No booking requests found</td></tr>';
        requestCount.textContent = '0 requests';
        return;
    }

    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, filteredBookings.length);
    const currentBookings = filteredBookings.slice(startIndex, endIndex);

    requestCount.textContent = `${filteredBookings.length} requests`;

    currentBookings.forEach(booking => {
        const row = document.createElement('tr');
        if (booking.status === 'Pending') {
            row.classList.add('highlighted-row');
        }

        const statusClass = `status-${booking.status.toLowerCase()}`;
        
        let actions = '';
        if (booking.status === 'Pending') {
            actions = `
                <button class="action-btn btn" onclick="openAllocationModal(${booking.id})">Allocate</button>
                <button class="action-btn btn btn-secondary" onclick="openEditModal(${booking.id})">Edit</button>
                <button class="action-btn btn btn-danger" onclick="deleteBooking(${booking.id})">Delete</button>
            `;
        } else if (booking.status === 'Approved') {
            actions = `
                <button class="action-btn btn" onclick="viewBooking(${booking.id})">View</button>
                <button class="action-btn btn btn-secondary" onclick="openEditModal(${booking.id})">Edit</button>
            `;
        } else {
            actions = `
                <button class="action-btn btn" onclick="viewBooking(${booking.id})">View</button>
                <button class="action-btn btn btn-secondary" onclick="openEditModal(${booking.id})">Edit</button>
            `;
        }

        row.innerHTML = `
            <td>${booking.refnumber}</td>
            <td>${booking.username}</td>
            <td>${booking.userbranch}</td>
            <td>${booking.destination}</td>
            <td>${formatDateTime(booking.startdatetime)}</td>
            <td>${booking.seatcount}</td>
            <td>${booking.distance} KM</td>
            <td><span class="status-badge ${statusClass}">${booking.status}</span></td>
            <td>${actions}</td>
        `;

        requestsTableBody.appendChild(row);
    });
}

function updatePagination() {
    const totalPages = Math.ceil(filteredBookings.length / itemsPerPage);
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
}

function goToPrevPage() {
    if (currentPage > 1) {
        currentPage--;
        displayBookings();
        updatePagination();
    }
}

function goToNextPage() {
    const totalPages = Math.ceil(filteredBookings.length / itemsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        displayBookings();
        updatePagination();
    }
}

// Modal Functions
function openAllocationModal(bookingId) {
    currentBookingId = bookingId;
    const booking = allBookings.find(b => b.id === bookingId);
    
    if (booking) {
        selectedVehicleId = null;
        selectedDriverId = null;
        selectedFuelStation = '';
        selectedExtraFuel = '';
        document.getElementById('selectedVehicleText').textContent = 'None selected';
        document.getElementById('selectedDriverText').textContent = 'None selected';
        document.getElementById('selectedFuelStationText').textContent = 'None selected';
        document.getElementById('selectedExtraFuelText').textContent = 'None specified';
        
        document.getElementById('searchVehicleModal').value = '';
        document.getElementById('searchDriverModal').value = '';
        document.getElementById('fuelStation').value = '';
        document.getElementById('extraFuel').value = '';
        vehicleModalPage = 1;
        driverModalPage = 1;
        
        document.getElementById('uniquePassword').value = booking.uniquepassword || '';
        
        filterModalVehicles();
        filterModalDrivers();
        
        showElement(document.getElementById('allocationModal'));
    }
}

function filterModalVehicles() {
    const searchTerm = document.getElementById('searchVehicleModal').value.toLowerCase();
    
    filteredModalVehicles = vehicles.filter(vehicle => {
        const vehicleNo = String(vehicle.vehicleno || '');
        const vehicleType = String(vehicle.type || '');
        const seatCapacity = String(vehicle.seatcapacity || '');
        
        const isAvailable = vehicle.status === 'Available';
        const searchMatch = !searchTerm || 
            vehicleNo.toLowerCase().includes(searchTerm) ||
            vehicleType.toLowerCase().includes(searchTerm) ||
            seatCapacity.includes(searchTerm);
        
        return isAvailable && searchMatch;
    });
    
    vehicleModalPage = 1;
    displayModalVehicles();
    updateVehicleModalPagination();
}

function displayModalVehicles() {
    const vehicleSelectionList = document.getElementById('vehicleSelectionList');
    vehicleSelectionList.innerHTML = '';
    
    if (filteredModalVehicles.length === 0) {
        vehicleSelectionList.innerHTML = '<div class="selection-item" style="text-align: center; color: #999;">No available vehicles found</div>';
        return;
    }

    const startIndex = (vehicleModalPage - 1) * modalItemsPerPage;
    const endIndex = Math.min(startIndex + modalItemsPerPage, filteredModalVehicles.length);
    const currentVehicles = filteredModalVehicles.slice(startIndex, endIndex);

    currentVehicles.forEach(vehicle => {
        const div = document.createElement('div');
        div.className = `selection-item ${selectedVehicleId === vehicle.id ? 'selected' : ''}`;
        div.innerHTML = `
            <div><strong>${vehicle.vehicleno}</strong> - ${vehicle.type}</div>
            <div style="color: #666; font-size: 0.9em;">${vehicle.seatcapacity} seats - ${vehicle.status}</div>
        `;
        div.addEventListener('click', () => selectVehicle(vehicle, div));
        vehicleSelectionList.appendChild(div);
    });
}

function selectVehicle(vehicle, element) {
    selectedVehicleId = vehicle.id;
    document.getElementById('selectedVehicleText').textContent = `${vehicle.vehicleno} - ${vehicle.type} (${vehicle.seatcapacity} seats)`;
    
    document.querySelectorAll('#vehicleSelectionList .selection-item').forEach(item => {
        item.classList.remove('selected');
    });
    element.classList.add('selected');
}

function filterModalDrivers() {
    const searchTerm = document.getElementById('searchDriverModal').value.toLowerCase();
    
    filteredModalDrivers = drivers.filter(driver => {
        const driverName = String(driver.name || '');
        const driverPhone = String(driver.phone || '');
        
        const isAvailable = driver.status === 'Available';
        const searchMatch = !searchTerm || 
            driverName.toLowerCase().includes(searchTerm) ||
            driverPhone.toLowerCase().includes(searchTerm);
        
        return isAvailable && searchMatch;
    });
    
    driverModalPage = 1;
    displayModalDrivers();
    updateDriverModalPagination();
}

function displayModalDrivers() {
    const driverSelectionList = document.getElementById('driverSelectionList');
    driverSelectionList.innerHTML = '';
    
    if (filteredModalDrivers.length === 0) {
        driverSelectionList.innerHTML = '<div class="selection-item" style="text-align: center; color: #999;">No available drivers found</div>';
        return;
    }

    const startIndex = (driverModalPage - 1) * modalItemsPerPage;
    const endIndex = Math.min(startIndex + modalItemsPerPage, filteredModalDrivers.length);
    const currentDrivers = filteredModalDrivers.slice(startIndex, endIndex);

    currentDrivers.forEach(driver => {
        const div = document.createElement('div');
        div.className = `selection-item ${selectedDriverId === driver.id ? 'selected' : ''}`;
        div.innerHTML = `
            <div><strong>${driver.name}</strong></div>
            <div style="color: #666; font-size: 0.9em;">${driver.phone} - ${driver.status}</div>
        `;
        div.addEventListener('click', () => selectDriver(driver, div));
        driverSelectionList.appendChild(div);
    });
}

function selectDriver(driver, element) {
    selectedDriverId = driver.id;
    document.getElementById('selectedDriverText').textContent = `${driver.name} (${driver.phone})`;
    
    document.querySelectorAll('#driverSelectionList .selection-item').forEach(item => {
        item.classList.remove('selected');
    });
    element.classList.add('selected');
}

function updateVehicleModalPagination() {
    const totalPages = Math.ceil(filteredModalVehicles.length / modalItemsPerPage);
    document.getElementById('vehiclePageInfo').textContent = `Page ${vehicleModalPage} of ${totalPages || 1}`;
    document.getElementById('vehiclePrevPage').disabled = vehicleModalPage === 1;
    document.getElementById('vehicleNextPage').disabled = vehicleModalPage === totalPages || totalPages === 0;
}

function updateDriverModalPagination() {
    const totalPages = Math.ceil(filteredModalDrivers.length / modalItemsPerPage);
    document.getElementById('driverPageInfo').textContent = `Page ${driverModalPage} of ${totalPages || 1}`;
    document.getElementById('driverPrevPage').disabled = driverModalPage === 1;
    document.getElementById('driverNextPage').disabled = driverModalPage === totalPages || totalPages === 0;
}

function goToVehiclePrevPage() {
    if (vehicleModalPage > 1) {
        vehicleModalPage--;
        displayModalVehicles();
        updateVehicleModalPagination();
    }
}

function goToVehicleNextPage() {
    const totalPages = Math.ceil(filteredModalVehicles.length / modalItemsPerPage);
    if (vehicleModalPage < totalPages) {
        vehicleModalPage++;
        displayModalVehicles();
        updateVehicleModalPagination();
    }
}

function goToDriverPrevPage() {
    if (driverModalPage > 1) {
        driverModalPage--;
        displayModalDrivers();
        updateDriverModalPagination();
    }
}

function goToDriverNextPage() {
    const totalPages = Math.ceil(filteredModalDrivers.length / modalItemsPerPage);
    if (driverModalPage < totalPages) {
        driverModalPage++;
        displayModalDrivers();
        updateDriverModalPagination();
    }
}

function openEditModal(bookingId) {
    currentBookingId = bookingId;
    const booking = allBookings.find(b => b.id === bookingId);
    
    if (booking) {
        document.getElementById('editUserName').value = booking.username || '';
        document.getElementById('editUserDesignation').value = booking.userdesignation || '';
        document.getElementById('editUserBranch').value = booking.userbranch || '';
        document.getElementById('editUserPhone').value = booking.userphone || '';
        document.getElementById('editApprovedBy').value = booking.approvedby || '';
        document.getElementById('editPurpose').value = booking.purpose || '';
        document.getElementById('editSeatCount').value = booking.seatcount || '';
        document.getElementById('editDistance').value = booking.distance || '';
        document.getElementById('editStartDateTime').value = booking.startdatetime ? booking.startdatetime.substring(0, 16) : '';
        document.getElementById('editEndDateTime').value = booking.enddatetime ? booking.enddatetime.substring(0, 16) : '';
        document.getElementById('editStartLocation').value = booking.startlocation || '';
        document.getElementById('editDestination').value = booking.destination || '';
        
        showElement(document.getElementById('editModal'));
    }
}

function viewBooking(bookingId) {
    currentBookingId = bookingId;
    const booking = allBookings.find(b => b.id === bookingId);
    
    if (booking) {
        document.getElementById('viewRefNumber').textContent = booking.refnumber;
        document.getElementById('viewDate').textContent = formatDate(booking.timestamp);
        document.getElementById('viewUserDetails').textContent = 
            `${booking.username}, ${booking.userdesignation}, ${booking.userphone}`;
        document.getElementById('viewBranch').textContent = booking.userbranch;
        document.getElementById('viewApprovedBy').textContent = booking.approvedby || 'Not specified';
        document.getElementById('viewTripDetails').textContent = 
            `${booking.purpose}. From ${booking.startlocation} to ${booking.destination}. ${formatDateTime(booking.startdatetime)} to ${formatDateTime(booking.enddatetime)}`;
        document.getElementById('viewVehicleReq').textContent = 
            `${booking.seatcount} seats, Goods Transport: ${booking.goodstransport || 'No'}`;
        document.getElementById('viewDistance').textContent = 
            `${booking.distance} KM`;
        document.getElementById('viewStatus').textContent = booking.status;
        document.getElementById('viewVehicle').textContent = booking.allocatedvehicle || 'Not allocated';
        document.getElementById('viewDriver').textContent = booking.allocateddriver || 'Not allocated';
        document.getElementById('viewFuelStation').textContent = booking.fuelstation || 'Not specified';
        document.getElementById('viewExtraFuel').textContent = booking.extrafuel ? `${booking.extrafuel} liters` : 'Not specified';
        
        const vehicleNumber = booking.allocatedvehicle ? booking.allocatedvehicle.split(' - ')[0] : '';
        generateQRCode(booking.refnumber, booking.startdatetime, booking.enddatetime, 'qrCodeAdmin', vehicleNumber, booking.uniquepassword);
        
        showElement(document.getElementById('viewModal'));
    }
}

async function allocateVehicle() {
    const uniquePassword = document.getElementById('uniquePassword').value.trim();
    const fuelStation = document.getElementById('fuelStation').value.trim();
    const extraFuel = document.getElementById('extraFuel').value.trim();
    
    if (!uniquePassword) {
        alert('Please enter the booking password');
        return;
    }
    
    if (!selectedVehicleId) {
        alert('Please select a vehicle');
        return;
    }
    
    if (!selectedDriverId) {
        alert('Please select a driver');
        return;
    }
    
    if (!fuelStation) {
        alert('Please enter the nominated fuel station');
        return;
    }
    
    if (!extraFuel) {
        alert('Please enter the amount of extra fuel');
        return;
    }
    
    const confirmAllocationBtn = document.getElementById('confirmAllocation');
    confirmAllocationBtn.disabled = true;
    
    try {
        const result = await callGoogleAppsScript('allocateVehicle', {
            bookingId: currentBookingId,
            vehicleId: selectedVehicleId,
            driverId: selectedDriverId,
            fuelStation: fuelStation,
            extraFuel: extraFuel,
            uniquePassword: uniquePassword
        });
        
        if (result.success) {
            alert('Vehicle and driver allocated successfully');
            hideModal('allocationModal');
            loadAdminData();
        } else {
            alert('Allocation failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Allocation failed. Please try again.');
    } finally {
        confirmAllocationBtn.disabled = false;
    }
}

async function saveEdit() {
    const confirmEditBtn = document.getElementById('confirmEdit');
    confirmEditBtn.disabled = true;
    
    try {
        const result = await callGoogleAppsScript('editBooking', {
            bookingId: currentBookingId,
            userName: document.getElementById('editUserName').value.trim(),
            userDesignation: document.getElementById('editUserDesignation').value.trim(),
            userBranch: document.getElementById('editUserBranch').value.trim(),
            userPhone: document.getElementById('editUserPhone').value.trim(),
            approvedBy: document.getElementById('editApprovedBy').value.trim(),
            purpose: document.getElementById('editPurpose').value.trim(),
            seatCount: document.getElementById('editSeatCount').value,
            distance: document.getElementById('editDistance').value,
            startDateTime: document.getElementById('editStartDateTime').value,
            endDateTime: document.getElementById('editEndDateTime').value,
            startLocation: document.getElementById('editStartLocation').value.trim(),
            destination: document.getElementById('editDestination').value.trim()
        });
        
        if (result.success) {
            alert('Booking updated successfully');
            hideModal('editModal');
            loadAdminData();
        } else {
            alert('Update failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Update failed. Please try again.');
    } finally {
        confirmEditBtn.disabled = false;
    }
}

async function deleteBooking(bookingId) {
    if (!confirm('Are you sure you want to delete this booking?')) {
        return;
    }
    
    try {
        const result = await callGoogleAppsScript('deleteBooking', { bookingId: bookingId });
        
        if (result.success) {
            alert('Booking deleted successfully');
            loadAdminData();
        } else {
            alert('Delete failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Delete failed. Please try again.');
    }
}

function hideModal(modalId) {
    showElement(document.getElementById(modalId), false);
}

// Vehicle Status Functions
function updateVehicleStatus() {
    const available = vehicles.filter(v => v.status === 'Available').length;
    const booked = vehicles.filter(v => v.status === 'Booked').length;
    const maintenance = vehicles.filter(v => v.status === 'Maintenance').length;
    
    document.getElementById('availableCount').textContent = available;
    document.getElementById('bookedCount').textContent = booked;
    document.getElementById('maintenanceCount').textContent = maintenance;
    
    displayVehicleList('availableVehiclesList', vehicles.filter(v => v.status === 'Available'));
    displayVehicleList('bookedVehiclesList', vehicles.filter(v => v.status === 'Booked'));
    displayVehicleList('maintenanceVehiclesList', vehicles.filter(v => v.status === 'Maintenance'));
}

function displayVehicleList(elementId, vehicleList) {
    const element = document.getElementById(elementId);
    element.innerHTML = '';
    
    if (vehicleList.length === 0) {
        element.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">No vehicles found</div>';
        return;
    }
    
    vehicleList.forEach(vehicle => {
        const li = document.createElement('li');
        const typeClass = vehicle.type.includes('4') ? 'vehicle-type-car' : 
                        vehicle.type.includes('7') ? 'vehicle-type-van' : 'vehicle-type-bus';
        
        li.innerHTML = `
            <div>
                <strong>${vehicle.vehicleno}</strong>
                <div style="margin-top: 5px;">
                    <span class="vehicle-type-badge ${typeClass}">${vehicle.type}</span>
                    <span style="margin-left: 10px; color: #666;">${vehicle.seatcapacity} seats</span>
                </div>
            </div>
        `;
        element.appendChild(li);
    });
}

function searchVehicles() {
    const searchTerm = document.getElementById('searchVehicles').value.toLowerCase();
    
    const availableVehicles = vehicles.filter(v => 
        v.status === 'Available' && (
            v.vehicleno.toLowerCase().includes(searchTerm) ||
            v.type.toLowerCase().includes(searchTerm)
        )
    );
    
    const bookedVehicles = vehicles.filter(v => 
        v.status === 'Booked' && (
            v.vehicleno.toLowerCase().includes(searchTerm) ||
            v.type.toLowerCase().includes(searchTerm)
        )
    );
    
    const maintenanceVehicles = vehicles.filter(v => 
        v.status === 'Maintenance' && (
            v.vehicleno.toLowerCase().includes(searchTerm) ||
            v.type.toLowerCase().includes(searchTerm)
        )
    );
    
    displayVehicleList('availableVehiclesList', availableVehicles);
    displayVehicleList('bookedVehiclesList', bookedVehicles);
    displayVehicleList('maintenanceVehiclesList', maintenanceVehicles);
}

// Report Functions
async function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    const reportResults = document.getElementById('reportResults');
    reportResults.innerHTML = '<div class="spinner"></div>';
    
    try {
        const result = await callGoogleAppsScript('getReports', {
            type: reportType,
            startDate: startDate,
            endDate: endDate
        });
        
        if (result.success) {
            displayReport(result);
        } else {
            reportResults.innerHTML = `<div style="color: var(--danger);">Error: ${result.error || 'Failed to generate report'}</div>`;
        }
    } catch (error) {
        reportResults.innerHTML = `<div style="color: var(--danger);">Error generating report: ${error.message}</div>`;
    }
}

function displayReport(result) {
    const reportResults = document.getElementById('reportResults');
    
    let html = `
        <div class="enhanced-pdf">
            <div class="enhanced-pdf-header">
                <div class="enhanced-pdf-title">${result.title}</div>
                <div class="enhanced-pdf-subtitle">Generated on ${formatDateTime(result.generatedAt)}</div>
            </div>
    `;
    
    if (result.reportData && result.reportData.length > 0) {
        html += '<div class="table-scroll-container"><table>';
        
        result.reportData.forEach((row, rowIndex) => {
            const rowClass = rowIndex === 0 ? 'style="font-weight: bold; background-color: #f8f9fa;"' : '';
            html += '<tr ' + rowClass + '>';
            
            row.forEach(cell => {
                html += '<td>' + (cell || '') + '</td>';
            });
            
            html += '</tr>';
        });
        
        html += '</table></div>';
    } else {
        html += '<p style="text-align: center; color: #999;">No data available for this report</p>';
    }
    
    html += '</div>';
    
    reportResults.innerHTML = html;
}

// System Logs Functions
async function loadSystemLogs() {
    try {
        const result = await callGoogleAppsScript('getSystemLogs');
        systemLogs = result.logs || [];
        
        const userFilter = document.getElementById('userFilter');
        const uniqueUsers = [...new Set(systemLogs.map(log => log.user))];
        
        userFilter.innerHTML = '<option value="all">All Users</option>';
        uniqueUsers.forEach(user => {
            const option = document.createElement('option');
            option.value = user;
            option.textContent = user;
            userFilter.appendChild(option);
        });
        
        filterLogs();
    } catch (error) {
        console.error('Error loading system logs:', error);
    }
}

function filterLogs() {
    const typeFilter = document.getElementById('logTypeFilter').value;
    const userFilter = document.getElementById('userFilter').value;
    const searchTerm = document.getElementById('searchLogs').value.toLowerCase();
    
    filteredLogs = systemLogs.filter(log => {
        const typeMatch = typeFilter === 'all' || log.type === typeFilter;
        const userMatch = userFilter === 'all' || log.user === userFilter;
        const searchMatch = !searchTerm || 
            log.user.toLowerCase().includes(searchTerm) ||
            log.action.toLowerCase().includes(searchTerm) ||
            log.details.toLowerCase().includes(searchTerm);
        
        return typeMatch && userMatch && searchMatch;
    });
    
    logsPage = 1;
    displayLogs();
    updateLogsPagination();
}

function displayLogs() {
    const systemLogsTable = document.getElementById('systemLogsTable');
    systemLogsTable.innerHTML = '';
    
    if (filteredLogs.length === 0) {
        systemLogsTable.innerHTML = '<tr><td colspan="5" class="text-center">No logs found</td></tr>';
        return;
    }

    const startIndex = (logsPage - 1) * logsItemsPerPage;
    const endIndex = Math.min(startIndex + logsItemsPerPage, filteredLogs.length);
    const currentLogs = filteredLogs.slice(startIndex, endIndex);

    currentLogs.forEach(log => {
        const tr = document.createElement('tr');
        const typeClass = `status-${log.type.toLowerCase()}`;
        
        tr.innerHTML = `
            <td>${formatDateTime(log.timestamp)}</td>
            <td><span class="status-badge ${typeClass}">${log.type}</span></td>
            <td>${log.user}</td>
            <td>${log.action}</td>
            <td>${log.details}</td>
        `;
        systemLogsTable.appendChild(tr);
    });
}

function updateLogsPagination() {
    const totalPages = Math.ceil(filteredLogs.length / logsItemsPerPage);
    document.getElementById('logsPageInfo').textContent = `Page ${logsPage} of ${totalPages}`;
    document.getElementById('logsPrevPage').disabled = logsPage === 1;
    document.getElementById('logsNextPage').disabled = logsPage === totalPages || totalPages === 0;
}

function goToLogsPrevPage() {
    if (logsPage > 1) {
        logsPage--;
        displayLogs();
        updateLogsPagination();
    }
}

function goToLogsNextPage() {
    const totalPages = Math.ceil(filteredLogs.length / logsItemsPerPage);
    if (logsPage < totalPages) {
        logsPage++;
        displayLogs();
        updateLogsPagination();
    }
}

function exportLogs() {
    const csvContent = "data:text/csv;charset=utf-8," 
        + "Timestamp,Type,User,Action,Details\n"
        + filteredLogs.map(log => 
            `"${formatDateTime(log.timestamp)}","${log.type}","${log.user}","${log.action}","${log.details}"`
        ).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "system_logs.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// QR Code Functions
function generateQRCode(refNumber, startDateTime, endDateTime, qrCodeElementId, vehicleNumber = '', uniquePassword = '') {
    const qrData = {
        refNumber: refNumber,
        startDateTime: startDateTime,
        endDateTime: endDateTime,
        vehicleNumber: vehicleNumber,
        uniquePassword: uniquePassword
    };
    
    const qrString = JSON.stringify(qrData);
    
    const qrCodeElement = document.getElementById(qrCodeElementId);
    qrCodeElement.innerHTML = '';
    
    const qr = qrcode(0, 'M');
    qr.addData(qrString);
    qr.make();
    
    qrCodeElement.innerHTML = qr.createImgTag(4);
}

// PDF Generation Functions - COMPLETE WITH PROPER IMPLEMENTATION
function generatePDF(isFinal = false) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(18);
    doc.setTextColor(26, 115, 232);
    doc.setFont(undefined, 'bold');
    doc.text('MINISTRY OF HEALTH', 105, 15, { align: 'center' });
    
    doc.setFontSize(13);
    doc.setTextColor(95, 99, 104);
    doc.text('Vehicle Booking System', 105, 22, { align: 'center' });
    
    doc.setDrawColor(26, 115, 232);
    doc.line(20, 27, 190, 27);
    
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    doc.text(isFinal ? 'VEHICLE BOOKING CONFIRMATION' : 'VEHICLE BOOKING REQUEST', 105, 35, { align: 'center' });
    
    if (isFinal) {
        const booking = allBookings.find(b => b.id === currentBookingId);
        if (booking) {
            addFormalBookingContentToPDF(doc, booking, true);
        }
    } else {
        addFormalPreviewContentToPDF(doc);
    }
    
    // Add Small QR Code in bottom right corner
    const qrSize = 25;
    const qrX = 190 - qrSize - 5;
    const qrY = 297 - qrSize - 10;
    
    const qrCodeElement = isFinal ? 
        document.querySelector('#qrCodeAdmin img') : 
        document.querySelector('#qrCodeUser img');
        
    if (qrCodeElement) {
        const qrCodeDataURL = qrCodeElement.src;
        doc.addImage(qrCodeDataURL, 'PNG', qrX, qrY, qrSize, qrSize);
    }
    
    // Footer
    doc.setFontSize(8);
    doc.setTextColor(128, 128, 128);
    doc.text('Official Document - Ministry of Health Vehicle Booking System', 105, 287, { align: 'center' });
    doc.text(`Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 105, 291, { align: 'center' });
    
    const fileName = isFinal ? 
        `booking_confirmation_${currentBookingRef}.pdf` : 
        `booking_request_${currentBookingRef}.pdf`;
    
    doc.save(fileName);
    
    logSystemActivity('system', currentUserRole, 'PDF Downloaded', 
        isFinal ? `Final confirmation for ${currentBookingRef}` : `Request preview for ${currentBookingRef}`);
}

function addFormalPreviewContentToPDF(doc) {
    let yPosition = 42;
    
    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    doc.text(`Booking Reference: ${currentBookingRef}`, 20, yPosition);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 130, yPosition);
    
    yPosition += 10;
    
    // User Details Section
    doc.setFont(undefined, 'bold');
    doc.setFontSize(11);
    doc.text('REQUESTOR DETAILS', 20, yPosition);
    doc.setFont(undefined, 'normal');
    doc.setFontSize(9);
    
    yPosition += 6;
    doc.text(`Name: ${document.getElementById('userName').value}`, 22, yPosition);
    yPosition += 5;
    doc.text(`Designation: ${document.getElementById('userDesignation').value}`, 22, yPosition);
    yPosition += 5;
    doc.text(`Branch/Section: ${document.getElementById('userBranch').value}`, 22, yPosition);
    yPosition += 5;
    doc.text(`Phone: ${document.getElementById('userPhone').value}`, 22, yPosition);
    yPosition += 5;
    doc.text(`Approved By: ${document.getElementById('approvedBy').value}`, 22, yPosition);
    
    yPosition += 10;
    
    // Trip Details Section
    doc.setFont(undefined, 'bold');
    doc.setFontSize(11);
    doc.text('TRIP DETAILS', 20, yPosition);
    doc.setFont(undefined, 'normal');
    doc.setFontSize(9);
    
    yPosition += 6;
    const purpose = document.getElementById('purpose').value;
    const purposeLines = doc.splitTextToSize(`Purpose: ${purpose}`, 170);
    doc.text(purposeLines, 22, yPosition);
    yPosition += purposeLines.length * 5;
    
    doc.text(`From: ${document.getElementById('startLocation').value}`, 22, yPosition);
    yPosition += 5;
    doc.text(`To: ${document.getElementById('destination').value}`, 22, yPosition);
    yPosition += 5;
    doc.text(`Start: ${formatDateTime(document.getElementById('startDateTime').value)}`, 22, yPosition);
    yPosition += 5;
    doc.text(`End: ${formatDateTime(document.getElementById('endDateTime').value)}`, 22, yPosition);
    
    yPosition += 10;
    
    // Vehicle Requirements Section
    doc.setFont(undefined, 'bold');
    doc.setFontSize(11);
    doc.text('VEHICLE REQUIREMENTS', 20, yPosition);
    doc.setFont(undefined, 'normal');
    doc.setFontSize(9);
    
    yPosition += 6;
    doc.text(`Seat Count: ${document.getElementById('seatCount').value}`, 22, yPosition);
    yPosition += 5;
    doc.text(`Approximate Distance: ${document.getElementById('distance').value} KM`, 22, yPosition);
    yPosition += 5;
    doc.text(`Goods Transport: ${document.getElementById('goodsTransport').checked ? 'Yes' : 'No'}`, 22, yPosition);
    
    yPosition += 10;
    
    // Status Section
    doc.setFont(undefined, 'bold');
    doc.setFontSize(11);
    doc.text('STATUS', 20, yPosition);
    doc.setFont(undefined, 'normal');
    doc.setFontSize(9);
    
    yPosition += 6;
    doc.text('Pending Approval', 22, yPosition);
    
    yPosition += 10;
    
    // Important Notice
    doc.setFont(undefined, 'bold');
    doc.setFontSize(10);
    doc.text('IMPORTANT INFORMATION', 20, yPosition);
    doc.setFont(undefined, 'normal');
    doc.setFontSize(9);
    
    yPosition += 6;
    doc.text('Please save this document for future reference and inquiries.', 22, yPosition);
    yPosition += 5;
    doc.text(`Your unique booking password: ${document.getElementById('uniquePasswordDisplay').textContent}`, 22, yPosition);
    
    yPosition += 12;
    
    // Signature area
    doc.line(20, yPosition, 90, yPosition);
    yPosition += 5;
    doc.setFont(undefined, 'bold');
    doc.setFontSize(9);
    doc.text('Approval Signature', 20, yPosition);
    yPosition += 4;
    doc.setFont(undefined, 'normal');
    doc.setFontSize(8);
    doc.text('Head of Department / Deputy Director General', 20, yPosition);
}

function addFormalBookingContentToPDF(doc, booking, isFinal = false) {
    let yPosition = 42;
    
    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    doc.text(`Booking Reference: ${booking.refnumber}`, 20, yPosition);
    doc.text(`Date: ${formatDate(booking.timestamp)}`, 130, yPosition);
    
    yPosition += 10;
    
    // User Details Section
    doc.setFont(undefined, 'bold');
    doc.setFontSize(11);
    doc.text('REQUESTOR DETAILS', 20, yPosition);
    doc.setFont(undefined, 'normal');
    doc.setFontSize(9);
    
    yPosition += 6;
    doc.text(`Name: ${booking.username}`, 22, yPosition);
    yPosition += 5;
    doc.text(`Designation: ${booking.userdesignation}`, 22, yPosition);
    yPosition += 5;
    doc.text(`Branch/Section: ${booking.userbranch}`, 22, yPosition);
    yPosition += 5;
    doc.text(`Phone: ${booking.userphone}`, 22, yPosition);
    yPosition += 5;
    doc.text(`Approved By: ${booking.approvedby}`, 22, yPosition);
    
    yPosition += 10;
    
    // Trip Details Section
    doc.setFont(undefined, 'bold');
    doc.setFontSize(11);
    doc.text('TRIP DETAILS', 20, yPosition);
    doc.setFont(undefined, 'normal');
    doc.setFontSize(9);
    
    yPosition += 6;
    const purposeLines = doc.splitTextToSize(`Purpose: ${booking.purpose}`, 170);
    doc.text(purposeLines, 22, yPosition);
    yPosition += purposeLines.length * 5;
    
    doc.text(`From: ${booking.startlocation}`, 22, yPosition);
    yPosition += 5;
    doc.text(`To: ${booking.destination}`, 22, yPosition);
    yPosition += 5;
    doc.text(`Start: ${formatDateTime(booking.startdatetime)}`, 22, yPosition);
    yPosition += 5;
    doc.text(`End: ${formatDateTime(booking.enddatetime)}`, 22, yPosition);
    
    yPosition += 10;
    
    // Vehicle Requirements
    if (booking.seatcount || booking.distance) {
        doc.setFont(undefined, 'bold');
        doc.setFontSize(11);
        doc.text('VEHICLE REQUIREMENTS', 20, yPosition);
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        
        yPosition += 6;
        if (booking.seatcount) {
            doc.text(`Seat Count: ${booking.seatcount}`, 22, yPosition);
            yPosition += 5;
        }
        if (booking.distance) {
            doc.text(`Approximate Distance: ${booking.distance} KM`, 22, yPosition);
            yPosition += 5;
        }
        if (booking.goodstransport !== undefined) {
            doc.text(`Goods Transport: ${booking.goodstransport ? 'Yes' : 'No'}`, 22, yPosition);
            yPosition += 5;
        }
        yPosition += 5;
    }
    
    // Allocation Details (if final)
    if (isFinal && booking.allocatedvehicle) {
        doc.setFont(undefined, 'bold');
        doc.setFontSize(11);
        doc.text('ALLOCATION DETAILS', 20, yPosition);
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        
        yPosition += 6;
        doc.text(`Vehicle: ${booking.allocatedvehicle}`, 22, yPosition);
        yPosition += 5;
        doc.text(`Driver: ${booking.allocateddriver}`, 22, yPosition);
        yPosition += 5;
        doc.text(`Fuel Station: ${booking.fuelstation || 'Not specified'}`, 22, yPosition);
        yPosition += 5;
        doc.text(`Extra Fuel: ${booking.extrafuel || 'Not specified'} liters`, 22, yPosition);
        yPosition += 10;
    }
    
    // Admin approval text for final PDF
    if (isFinal) {
        doc.setFontSize(9);
        doc.setTextColor(0, 0, 0);
        
        doc.text('DDG(L)/D(T-A)/SA(T)', 20, yPosition);
        yPosition += 6;
        
        const approvalText = [
            '"I kindly submit for approval the following details concerning the automated vehicle request',
            'forwarded by the Vehicle Booking System - Ministry of Health to the Admin User - Transport',
            'Branch - Ministry of Health: the name of the officer who made the request, the approval for the',
            'request, the route and dates, the driver, the nominated fuel station for obtaining fuel, and for',
            `an amount of extra diesel/petrol of ${booking.extrafuel || '...'} liters.`,
            '',
            'Furthermore, I kindly submit for approval the payment of full overtime and travel allowances',
            'to the aforementioned driver and Cleaner (................................) for carrying out the',
            'duties on behalf of the above-named officer."'
        ];
        
        approvalText.forEach(line => {
            doc.text(line, 20, yPosition, { maxWidth: 170 });
            yPosition += 5;
        });
        
        yPosition += 5;
    }
    
    // Signature area
    doc.line(20, yPosition, 90, yPosition);
    yPosition += 5;
    doc.setFont(undefined, 'bold');
    doc.setFontSize(9);
    doc.text('Approval Signature', 20, yPosition);
    yPosition += 4;
    doc.setFont(undefined, 'normal');
    doc.setFontSize(8);
    doc.text('Head of Department / Deputy Director General', 20, yPosition);
}

function downloadFinalPDF() {
    generatePDF(true);
}

function downloadPreviewPDF() {
    generatePDF(false);
}

function downloadGatePassQR() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const booking = allBookings.find(b => b.id === currentBookingId);
    
    // Header
    doc.setFontSize(18);
    doc.setTextColor(26, 115, 232);
    doc.setFont(undefined, 'bold');
    doc.text('MINISTRY OF HEALTH', 105, 20, { align: 'center' });
    
    doc.setFontSize(14);
    doc.setTextColor(95, 99, 104);
    doc.text('Vehicle Gate Pass', 105, 30, { align: 'center' });
    
    doc.setDrawColor(26, 115, 232);
    doc.line(20, 35, 190, 35);
    
    // Booking Details
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'bold');
    doc.text(`Booking Reference: ${currentBookingRef}`, 20, 45);
    doc.setFont(undefined, 'normal');
    doc.setFontSize(10);
    
    if (booking) {
        doc.text(`Date: ${formatDate(booking.timestamp)}`, 20, 52);
        doc.text(`Vehicle: ${booking.allocatedvehicle || 'Not allocated'}`, 20, 59);
        doc.text(`Driver: ${booking.allocateddriver || 'Not allocated'}`, 20, 66);
        doc.text(`Destination: ${booking.destination}`, 20, 73);
        doc.text(`Start: ${formatDateTime(booking.startdatetime)}`, 20, 80);
        doc.text(`End: ${formatDateTime(booking.enddatetime)}`, 20, 87);
    } else {
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 52);
    }
    
    // QR Code
    const qrCodeElement = document.getElementById('qrCodeAdmin');
    if (qrCodeElement) {
        const qrImg = qrCodeElement.querySelector('img');
        if (qrImg) {
            const imgData = qrImg.src;
            const qrSize = 80;
            const qrX = (doc.internal.pageSize.getWidth() - qrSize) / 2;
            doc.addImage(imgData, 'PNG', qrX, 100, qrSize, qrSize);
        }
    }
    
    // Instructions
    doc.setFontSize(10);
    doc.setTextColor(95, 99, 104);
    doc.text('Scan this QR code at the gate for verification', 105, 190, { align: 'center' });
    
    // Footer
    doc.setFontSize(8);
    doc.setTextColor(128, 128, 128);
    doc.text('Official Gate Pass - Ministry of Health', 105, 280, { align: 'center' });
    doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 285, { align: 'center' });
    
    doc.save(`gate-pass-${currentBookingRef}.pdf`);
    
    logSystemActivity('system', currentUserRole, 'Gate Pass Downloaded', `Ref: ${currentBookingRef}`);
}

function sendWhatsApp() {
    const bookingRef = currentBookingRef;
    const uniquePassword = document.getElementById('uniquePasswordDisplay').textContent;
    const message = `Vehicle Booking Confirmation
Ministry of Health

Booking Ref: ${bookingRef}
Password: ${uniquePassword}
Status: Pending Approval

Please save this information for future reference.`;
    
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
    
    logSystemActivity('system', 'User', 'WhatsApp Shared', `Ref: ${bookingRef}`);
}

function sendWhatsAppAdmin() {
    const booking = allBookings.find(b => b.id === currentBookingId);
    if (!booking) return;
    
    const message = `Vehicle Booking Details
Ministry of Health

Ref: ${booking.refnumber}
Status: ${booking.status}
Requester: ${booking.username}
Destination: ${booking.destination}
Date: ${formatDateTime(booking.startdatetime)}

Vehicle: ${booking.allocatedvehicle || 'Not allocated'}
Driver: ${booking.allocateddriver || 'Not allocated'}
Fuel Station: ${booking.fuelstation || 'Not specified'}
Extra Fuel: ${booking.extrafuel || 'Not specified'} liters`;
    
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
    
    logSystemActivity('system', 'Administrator', 'WhatsApp Shared', `Ref: ${booking.refnumber}`);
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Initialize localStorage
    initializeLocalStorage();
    
    // Role selection
    document.querySelectorAll('.role-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.role-option').forEach(el => el.classList.remove('active'));
            this.classList.add('active');
            currentUserRole = this.getAttribute('data-role');
        });
    });
    
    // Login button
    document.getElementById('loginBtn').addEventListener('click', handleLogin);
    
    // Logout buttons
    document.getElementById('userLogout').addEventListener('click', logout);
    document.getElementById('adminLogout').addEventListener('click', logout);
    
    // Submit booking
    document.getElementById('submitBooking').addEventListener('click', submitBooking);
    
    // New booking
    document.getElementById('newBooking').addEventListener('click', resetBookingForm);
    
    // Download PDF
    document.getElementById('downloadPdf').addEventListener('click', downloadPreviewPDF);
    
    // Send WhatsApp
    document.getElementById('sendWhatsApp').addEventListener('click', sendWhatsApp);
    
    // Download final PDF
    document.getElementById('downloadFinalPdf').addEventListener('click', downloadFinalPDF);
    
    // Download gate pass QR
    document.getElementById('downloadGatePass').addEventListener('click', downloadGatePassQR);
    
    // Send WhatsApp admin
    document.getElementById('sendWhatsAppAdmin').addEventListener('click', sendWhatsAppAdmin);
    
    // User tabs
    document.querySelectorAll('.user-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.user-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            document.querySelectorAll('.user-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            const tabId = this.getAttribute('data-tab') + 'Tab';
            document.getElementById(tabId).classList.remove('hidden');
            
            if (this.getAttribute('data-tab') === 'myRequests') {
                loadMyRequests();
            } else if (this.getAttribute('data-tab') === 'vehicles') {
                updateUserVehicleStatus();
            }
        });
    });
    
    // My Requests filters
    document.getElementById('myRequestsStatusFilter').addEventListener('change', filterMyRequests);
    document.getElementById('searchMyRequests').addEventListener('input', filterMyRequests);
    
    // My Requests pagination
    document.getElementById('myRequestsPrevPage').addEventListener('click', goToMyRequestsPrevPage);
    document.getElementById('myRequestsNextPage').addEventListener('click', goToMyRequestsNextPage);
    
    // User vehicle search
    document.getElementById('searchUserVehicles').addEventListener('input', filterUserVehicles);
    
    // User vehicle pagination
    document.getElementById('userPrevPage').addEventListener('click', goToUserPrevPage);
    document.getElementById('userNextPage').addEventListener('click', goToUserNextPage);
    
    // Admin tabs
    document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            const tabId = this.getAttribute('data-tab') + 'Tab';
            document.getElementById(tabId).classList.remove('hidden');
            
            if (this.getAttribute('data-tab') === 'logs') {
                loadSystemLogs();
            }
        });
    });
    
    // Booking filters
    document.getElementById('statusFilter').addEventListener('change', filterBookings);
    document.getElementById('searchBookings').addEventListener('input', filterBookings);
    
    // Booking pagination
    document.getElementById('prevPage').addEventListener('click', goToPrevPage);
    document.getElementById('nextPage').addEventListener('click', goToNextPage);
    
    // Vehicle search
    document.getElementById('searchVehicles').addEventListener('input', searchVehicles);
    
    // Modal close buttons
    document.querySelectorAll('.close-modal').forEach(button => {
        button.addEventListener('click', function() {
            const modal = this.closest('.modal');
            showElement(modal, false);
        });
    });
    
    // Cancel buttons
    document.getElementById('cancelAllocation').addEventListener('click', function() {
        hideModal('allocationModal');
    });
    
    document.getElementById('cancelEdit').addEventListener('click', function() {
        hideModal('editModal');
    });
    
    document.getElementById('closeView').addEventListener('click', function() {
        hideModal('viewModal');
    });
    
    // Modal confirm buttons
    document.getElementById('confirmAllocation').addEventListener('click', allocateVehicle);
    document.getElementById('confirmEdit').addEventListener('click', saveEdit);
    
    // Modal searches
    document.getElementById('searchVehicleModal').addEventListener('input', filterModalVehicles);
    document.getElementById('searchDriverModal').addEventListener('input', filterModalDrivers);
    
    // Fuel station and extra fuel inputs - update display
    document.getElementById('fuelStation').addEventListener('input', function() {
        const value = this.value.trim();
        document.getElementById('selectedFuelStationText').textContent = value || 'None selected';
    });
    
    document.getElementById('extraFuel').addEventListener('input', function() {
        const value = this.value.trim();
        document.getElementById('selectedExtraFuelText').textContent = value ? `${value} liters` : 'None specified';
    });
    
    // Modal pagination
    document.getElementById('vehiclePrevPage').addEventListener('click', goToVehiclePrevPage);
    document.getElementById('vehicleNextPage').addEventListener('click', goToVehicleNextPage);
    document.getElementById('driverPrevPage').addEventListener('click', goToDriverPrevPage);
    document.getElementById('driverNextPage').addEventListener('click', goToDriverNextPage);
    
    // Report generation
    document.getElementById('generateReport').addEventListener('click', generateReport);
    
    // Logs filters
    document.getElementById('logTypeFilter').addEventListener('change', filterLogs);
    document.getElementById('userFilter').addEventListener('change', filterLogs);
    document.getElementById('searchLogs').addEventListener('input', filterLogs);
    
    // Logs pagination
    document.getElementById('logsPrevPage').addEventListener('click', goToLogsPrevPage);
    document.getElementById('logsNextPage').addEventListener('click', goToLogsNextPage);
    
    // Logs buttons
    document.getElementById('refreshLogs').addEventListener('click', loadSystemLogs);
    document.getElementById('exportLogs').addEventListener('click', exportLogs);
    
    // Close modals when clicking outside
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                showElement(this, false);
            }
        });
    });
    
    // Enter key for login
    document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleLogin();
        }
    });
});
    </script>
</body>
</html>
